{"data":{"post":{"id":"12bfd140-813c-55b8-99bb-55ddf22a02ab","html":"<blockquote>\n<p>This is the first (and maybe least interessting) post of a small series on AES-NI and .NET Core hardware intrinsics. Please be patient for the next post, which will actually start to take a deep dive into AES-NI. This one is more about efficiently using the existing crypto APIs in .NET. (Link to the follow up posts will be added )</p>\n</blockquote>\n<h2>Motivation</h2>\n<p>So I was researching <a href=\"https://software.intel.com/sites/default/files/article/165683/aes-wp-2012-09-22-v01.pdf\">AES New Instructions (AES-NI)</a> and the support for <a href=\"https://devblogs.microsoft.com/dotnet/using-net-hardware-intrinsics-api-to-accelerate-machine-learning-scenarios/\">hardware intrinsics in .NET Core 3.0</a> when i stumbeled over <a href=\"https://github.com/ronnieholm/Playground/tree/master/TrustpilotAesChallenge\">this repository</a> comparing different implementations of a <a href=\"http://followthewhiterabbit.trustpilot.com/challenge2.html\">coding challenge</a> from <a href=\"https://www.trustpilot.com/\">Trustpilot</a>. What puzzled me most, was the fact that the .NET Core implementation took 6 minutes to complete, while an implementation in C only required 9 seconds (a factor of 40 slower!). I woulnd‚Äôt have been surprised if a well optimized native implementation of a given problem is faster than the equivalent managed implementation in C#, but the factor was just way too high. So I started to tweak the code (first a little, then a LOT) and ended up with a solution that outperformed the implementation in C by a factor of ~4 üòÖ. But this post is only about the first 10x improvement, with more to follow.</p>\n<h2>The challenge</h2>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">We have a message for you.\nIt‚Äôs 3ncryp73d and we want you to crack it.\nThe decrypted message will contain further instructions.\n\nKnowns:\n- The algorithm is AES (Rijndael)\n- Blocksize: 128\n- Keysize: 256\n- You only need to find the first 6 bytes of the key, the rest are 0‚Äôs, so:\n    [?,?,?,?,?,?,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]\n- All bytes in the key has an integer value between 0 and 16.\n- The initialization vector is (base64 encoded): &quot;DkBbcmQo1QH+ed1wTyBynA==&quot;\n- The text is just plain ASCII english\n\nThe encrypted text (base64 encoded):\n\nyptyoDdVBdQtGhgoePppYHnWyugGmy0j81sf3zBeUXEO/LYRw+2XmVa0/v6YiSy9Kj8gMn/gNu2I7dPmfgSEHPUDJpNpiOWmmW1/jw/Pt29Are5tumWmnfkazcAb23xe7B4ruPZVxUEhfn/IrZPNZdr4cQNrHNgEv2ts8gVFuOBU+p792UPy8/mEIhW5ECppxGIb7Yrpg4w7IYNeFtX5d9W4W1t2e+6PcdcjkBK4a8y1cjEtuQ07RpPChOvLcSzlB/Bg7UKntzorRsn+y/d72qD2QxRzcXgbynCNalF7zaT6pEnwKB4i05fTQw6nB7SU1w2/EvCGlfiyR2Ia08mA0GikqegYA6xG/EAGs3ZJ0aQUGt0YZz0P7uBsQKdmCg7jzzEMHyGZDNGTj0F2dOFHLSOTT2/GGSht8eD/Ae7u/xnJj0bGgAKMtNttGFlNyvKpt2vDDT3Orfk6Jk/rD4CIz6O/Tnt0NkJLucHtIyvBYGtQR4+mhbfUELkczeDSxTXGDLaiU3de6tPaa0/vjzizoUbNFdfkIly/HWINdHoO83E=\n\n\nTrustpilot Development Team\nBiting the red pill</code></pre></div>\n<blockquote>\n<p>Trustpilot: <a href=\"http://followthewhiterabbit.trustpilot.com/challenge2.html\">http://followthewhiterabbit.trustpilot.com/challenge2.html</a></p>\n</blockquote>\n<h2>Analyzing the Performance Bottleneck</h2>\n<p>The idea behind the original implementation is quite smart and wasn‚Äôt changed throughout my optimization attemtps. It could be summarized as ‚ÄúLet‚Äôs decrypt the given ciphertext using all possible keys matching the descrption from the challenge and verify whether the result is readable by searching for the word ‚Äútrust‚Äù in the resulting plaintexts‚Äù.</p>\n<p>The original implementation constis of a call to the following method in the inner loop of its <code class=\"language-text\">Main</code> method.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">string</span> <span class=\"token function\">Decrypt</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> cipherText<span class=\"token punctuation\">,</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> key<span class=\"token punctuation\">,</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> iv<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> decryptor <span class=\"token operator\">=</span> aes<span class=\"token punctuation\">.</span><span class=\"token function\">CreateDecryptor</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> iv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> ms <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MemoryStream</span><span class=\"token punctuation\">(</span>cipherText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> cs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CryptoStream</span><span class=\"token punctuation\">(</span>ms<span class=\"token punctuation\">,</span> decryptor<span class=\"token punctuation\">,</span> CryptoStreamMode<span class=\"token punctuation\">.</span>Read<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> sr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StreamReader</span><span class=\"token punctuation\">(</span>cs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> sr<span class=\"token punctuation\">.</span><span class=\"token function\">ReadToEnd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>A simple enough method decrypting a given <code class=\"language-text\">cipherText</code> with a provided <code class=\"language-text\">key</code> and <code class=\"language-text\">iv</code> using AES (CBC without padding). Running this implementaiton with a profiler attached revieled the following numbers.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5353168556e557880f81b9c2e8bce978/33a01/original.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 32.0973348783314%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABLklEQVQY0z2R2ZKCMBBF/f//8mVqaqZc0CBrWEIgrLIpat1pWmseTt0O3X0qwEZFObbbE6xzAEtMkHGFKFHwghi248N2fa51UaNuezTXEdP9hfH2/PDAMK8snJusXrAXCns7wvGSwHIVLCfF7izxvXfw9Ss4f44e94Wfw08bBKplQn1FWt2gPmyKdsEl0HBCDU8WCJIKfmzoWQbLlhBeCttXPBOmNaRqeCbSHVIzoGjvMOQw3YOThcLL/pc8kvlxyfXZTRjhUS9891bZKsqq+cMEZUaocuSahA8aLmhxvYmGKw0tlnDotqvoSJ9idwpwEJJZ5yJ6zZU470k+IikGYqSahN2wQCYFwlhT5ohTgySroPIa2nScZTui7W9oiPo604+h7GY+9/OLeKKf3vwBcfG8JpL1Nr0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\"\n        alt=\"Original implementation - Profiled\"\n        title=\"\"\n        src=\"/static/5353168556e557880f81b9c2e8bce978/48538/original.png\"\n        srcset=\"/static/5353168556e557880f81b9c2e8bce978/bed0f/original.png 200w,\n/static/5353168556e557880f81b9c2e8bce978/5fd34/original.png 400w,\n/static/5353168556e557880f81b9c2e8bce978/48538/original.png 800w,\n/static/5353168556e557880f81b9c2e8bce978/33a01/original.png 863w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>85% of the time was spent in <code class=\"language-text\">StreamReader</code>s <code class=\"language-text\">ReadToEnd</code> method! So what if we could come up with an approach that could operate on the raw bytes retured by the decryption, instead of converting it into a <code class=\"language-text\">string</code>? Well, we could save a lot of time, thats what. I rewrote the <code class=\"language-text\">Decrypt</code> method to accept a <code class=\"language-text\">plaintext</code> buffer to store the result to. This helps avoid allocations, as the buffer can be reused in all iterations. </p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">Decrypt</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> cipherText<span class=\"token punctuation\">,</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> plaintext<span class=\"token punctuation\">,</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> key<span class=\"token punctuation\">,</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> iv<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> decryptor <span class=\"token operator\">=</span> aes<span class=\"token punctuation\">.</span><span class=\"token function\">CreateDecryptor</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> iv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    decryptor<span class=\"token punctuation\">.</span><span class=\"token function\">TransformBlock</span><span class=\"token punctuation\">(</span>cipherText<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> cipherText<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">,</span> plaintext<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The check if the resulting <code class=\"language-text\">plaintext</code> contains the word ‚Äútrust‚Äù was simple enough, using the highly optimized methods provided on <code class=\"language-text\">Span&lt;byte&gt;</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> ReadOnlySpan<span class=\"token operator\">&lt;</span><span class=\"token keyword\">byte</span><span class=\"token operator\">></span> trust <span class=\"token operator\">=</span><span class=\"token operator\">></span> \n    <span class=\"token keyword\">new</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span><span class=\"token number\">0x74</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x72</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x75</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x73</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x74</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">ContainsTrust</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> plaintext<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span>\n    plaintext<span class=\"token punctuation\">.</span><span class=\"token function\">AsSpan</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">IndexOf</span><span class=\"token punctuation\">(</span>trust<span class=\"token punctuation\">)</span> <span class=\"token operator\">>=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>With all of that in place, I re-ran the tool again with the profiler attached and sure enough, we now spend 85% of the time in the crypto functions of the framework, instead of doing conversions. Avoiding allocations and <code class=\"language-text\">string</code>s is almost always a good idea, if you aim for high performance.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8940b9fc5752bf98939d697d201d2beb/c51d8/no_convert.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 24.009060022650054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABAUlEQVQY04WO6U6DQBSFef/3Mk3cohVraVkKAwPDMkV2C/Zzir+NN/lyzr3JPTnWZrPD3gV8OANCasIowfUiHDdgf/DwAkGqKspzQ17W6M+eflroxpl2uBg/03+Z3egN6+7Jxz4ItnthVGIfk9U/2z4Pr8eV+xeHxzd3vW0dwbsr2bkpzqnAjTWntCEuR8OE5UXSNMuJEoU0TaQ6c4oVQZQRGvVDiesLjoY4q0xbTZyWZEVN08/U3WXl5pt+wYqiM1makecaXbVImRALQeD7hGFobhXfy8I8z1yvV/4bS6mSoihQKqeqNHVd03UdbdvSNA39MDBNE+M4/oaap1vwX/wAeXN3ksph7KoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\"\n        alt=\"No conversion - Profiled\"\n        title=\"\"\n        src=\"/static/8940b9fc5752bf98939d697d201d2beb/48538/no_convert.png\"\n        srcset=\"/static/8940b9fc5752bf98939d697d201d2beb/bed0f/no_convert.png 200w,\n/static/8940b9fc5752bf98939d697d201d2beb/5fd34/no_convert.png 400w,\n/static/8940b9fc5752bf98939d697d201d2beb/48538/no_convert.png 800w,\n/static/8940b9fc5752bf98939d697d201d2beb/c51d8/no_convert.png 883w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>So I was happy for the day and opened a <a href=\"https://github.com/ronnieholm/Playground/pull/1\">PR</a>. Who knew, that I couldn‚Äôt just let it be like that‚Ä¶ but more on that, in the next part.</p>","fields":{"slug":"/aes-ni-system-runtime-intrinsics/","prefix":"2019-03-13"},"frontmatter":{"title":"Outperforming OpenSSL in .NET Core using AES-NI","author":"nicolas portmann","category":"crypto","cover":{"childImageSharp":{"resize":{"src":"/static/d800d1366a59cb100ebe29a1dd636408/ada8c/kolleen-gladden-224796-unsplash.jpg"}}}}},"authornote":{"id":"37e21f59-b45d-5bbb-87bd-acb76a2de5c3","html":"<p><strong>Nicolas Portmann</strong> Software developer working on the back-end of the swiss cashless payment platform. Writing code for hardware security modules (Embedded C) and bridging the gap between low level network protocols and high level business applications (in Java/C#).</p>"}},"pageContext":{"slug":"/aes-ni-system-runtime-intrinsics/","prev":{"id":"02a0c736-732d-5ec7-802c-c7b40700924f","fields":{"slug":"/pascals-triangle/","prefix":"2019-02-15","source":"posts"},"frontmatter":{"title":"Pascal's triangle","category":"scala"}},"source":"posts"}}