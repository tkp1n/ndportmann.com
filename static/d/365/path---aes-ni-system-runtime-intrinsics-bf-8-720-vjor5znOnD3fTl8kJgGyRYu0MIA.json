{"data":{"post":{"id":"12bfd140-813c-55b8-99bb-55ddf22a02ab","html":"<h2>Motivation</h2>\n<p>So I was researching <a href=\"https://software.intel.com/sites/default/files/article/165683/aes-wp-2012-09-22-v01.pdf\">AES New Instructions (AES-NI)</a> and the support for <a href=\"https://devblogs.microsoft.com/dotnet/using-net-hardware-intrinsics-api-to-accelerate-machine-learning-scenarios/\">hardware intrinsics in .NET Core 3.0</a> when i stumbeled over <a href=\"https://github.com/ronnieholm/Playground/tree/master/TrustpilotAesChallenge\">this repository</a> comparing different implementations of a <a href=\"http://followthewhiterabbit.trustpilot.com/challenge2.html\">coding challenge</a> from <a href=\"https://www.trustpilot.com/\">Trustpilot</a>. What puzzled me most, was the fact that the .NET Core implementation took 6 minutes to complete, while an implementation in C only required 9 seconds (a factor of 40 slower!). I woulnd‚Äôt have been surprised if a well optimized native implementation of a given problem is faster than the equivalent managed implementation in C#, but the factor was just way too high. So I started to tweak the code and ended up with a solution that outperformed the implementation in C by a factor of ~4 üòÖ.</p>\n<h2>Analyzing the Performance Bottleneck</h2>\n<p>The idea behind the original implementation is quite smart and wasn‚Äôt changed throughout my optimization attemtps: ‚ÄúLet‚Äôs decrypt the given ciphertext using all possible keys matching the descrption from the challenge and verify whether the result is readable by searching for the word ‚Äútrust‚Äù in the resulting plaintexts‚Äù.</p>\n<p>The original implementation constis of a call to the following method in the inner loop of its <code class=\"language-text\">Main</code> method.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">string</span> <span class=\"token function\">Decrypt</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> cipherText<span class=\"token punctuation\">,</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> key<span class=\"token punctuation\">,</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> iv<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> decryptor <span class=\"token operator\">=</span> aes<span class=\"token punctuation\">.</span><span class=\"token function\">CreateDecryptor</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> iv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> ms <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MemoryStream</span><span class=\"token punctuation\">(</span>cipherText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> cs <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CryptoStream</span><span class=\"token punctuation\">(</span>ms<span class=\"token punctuation\">,</span> decryptor<span class=\"token punctuation\">,</span> CryptoStreamMode<span class=\"token punctuation\">.</span>Read<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">using</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> sr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">StreamReader</span><span class=\"token punctuation\">(</span>cs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> sr<span class=\"token punctuation\">.</span><span class=\"token function\">ReadToEnd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>A simple enough method decrypting a given <code class=\"language-text\">cipherText</code> using a provided <code class=\"language-text\">key</code> and <code class=\"language-text\">iv</code> using AES (CBC without padding). Running this implementaiton with a profiler attached revieled the following numbers.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5353168556e557880f81b9c2e8bce978/33a01/original.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 32.0973348783314%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABLklEQVQY0z2R2ZKCMBBF/f//8mVqaqZc0CBrWEIgrLIpat1pWmseTt0O3X0qwEZFObbbE6xzAEtMkHGFKFHwghi248N2fa51UaNuezTXEdP9hfH2/PDAMK8snJusXrAXCns7wvGSwHIVLCfF7izxvXfw9Ss4f44e94Wfw08bBKplQn1FWt2gPmyKdsEl0HBCDU8WCJIKfmzoWQbLlhBeCttXPBOmNaRqeCbSHVIzoGjvMOQw3YOThcLL/pc8kvlxyfXZTRjhUS9891bZKsqq+cMEZUaocuSahA8aLmhxvYmGKw0tlnDotqvoSJ9idwpwEJJZ5yJ6zZU470k+IikGYqSahN2wQCYFwlhT5ohTgySroPIa2nScZTui7W9oiPo604+h7GY+9/OLeKKf3vwBcfG8JpL1Nr0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\"\n        alt=\"Original implementation - Profiled\"\n        title=\"\"\n        src=\"/static/5353168556e557880f81b9c2e8bce978/48538/original.png\"\n        srcset=\"/static/5353168556e557880f81b9c2e8bce978/bed0f/original.png 200w,\n/static/5353168556e557880f81b9c2e8bce978/5fd34/original.png 400w,\n/static/5353168556e557880f81b9c2e8bce978/48538/original.png 800w,\n/static/5353168556e557880f81b9c2e8bce978/33a01/original.png 863w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>85% of the time was spent in <code class=\"language-text\">StreamReader</code>s <code class=\"language-text\">ReadToEnd</code> method! So what if we could come up with an approach that could operate on the raw bytes retured by the decryption, instead of converting it into a <code class=\"language-text\">string</code>? Well, we could save a lot of time, thats what.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">        <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">Decrypt</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> cipherText<span class=\"token punctuation\">,</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> plaintext<span class=\"token punctuation\">,</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> key<span class=\"token punctuation\">,</span> <span class=\"token keyword\">byte</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> iv<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">var</span> decryptor <span class=\"token operator\">=</span> aes<span class=\"token punctuation\">.</span><span class=\"token function\">CreateDecryptor</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> iv<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            decryptor<span class=\"token punctuation\">.</span><span class=\"token function\">TransformBlock</span><span class=\"token punctuation\">(</span>cipherText<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> cipherText<span class=\"token punctuation\">.</span>Length<span class=\"token punctuation\">,</span> plaintext<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span></code></pre></div>","fields":{"slug":"/aes-ni-system-runtime-intrinsics/","prefix":"2019-03-13"},"frontmatter":{"title":"Outperforming OpenSSL in .NET Core using AES-NI","author":"nicolas portmann","category":"crypto","cover":{"childImageSharp":{"resize":{"src":"/static/d800d1366a59cb100ebe29a1dd636408/ada8c/kolleen-gladden-224796-unsplash.jpg"}}}}},"authornote":{"id":"37e21f59-b45d-5bbb-87bd-acb76a2de5c3","html":"<p><strong>Nicolas Portmann</strong> Software developer working on the back-end of the swiss cashless payment platform. Writing code for hardware security modules (Embedded C) and bridging the gap between low level network protocols and high level business applications (in Java/C#).</p>"}},"pageContext":{"slug":"/aes-ni-system-runtime-intrinsics/","prev":{"id":"02a0c736-732d-5ec7-802c-c7b40700924f","fields":{"slug":"/pascals-triangle/","prefix":"2019-02-15","source":"posts"},"frontmatter":{"title":"Pascal's triangle","category":"scala"}},"source":"posts"}}