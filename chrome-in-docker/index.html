<!DOCTYPE html><!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Running Chrome in Docker for CI/CD</title>
        <meta name="description" content="A Software Engineering Blog">
        <meta property="og:url" content="https://ndportmann.com/chrome-in-docker/">
        <meta property="og:title" content="Running Chrome in Docker for CI/CD">
        <meta property="og:description" content="A blog about software engineering and applied cryptography.">
        <meta property="og:type" content="article">
        <meta name="twitter:site" content="@tkp1n">
        <meta name="twitter:creator" content="@tkp1n">
        <meta name="twitter:card" content="summary">
        <style>
            
            /*! tailwindcss v2.1.1 | MIT License | https://tailwindcss.com *//*! modern-normalize v1.0.0 | MIT License | https://github.com/sindresorhus/modern-normalize */*,::after,::before{box-sizing:border-box}:root{-moz-tab-size:4;tab-size:4}html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji'}hr{height:0;color:inherit}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset{margin:0;padding:0}ol,ul{list-style:none;margin:0;padding:0}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}body{font-family:inherit;line-height:inherit}*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}:root{--size-0_5:0.125rem;--size-1:0.250rem;--size-1_5:0.375rem;--size-2:0.5rem;--size-3:0.75rem;--size-3_5:0.875rem;--size-4:1rem;--size-4_5:1.125rem;--size-5:1.25rem;--size-6:1.5rem;--size-7:1.75rem;--size-7_5:1.875rem;--size-8:2rem;--size-9:2.25rem;--size-10:2.5rem;--size-xs:20rem;--size-md:28rem;--weight-extralight:200;--weight-light:300;--weight-bitbold:400;--weight-semibold:600;--blue-500:rgba(59, 130, 246, 1);--blue-600:rgba(37, 99, 235, 1);--blue-800:rgba(37, 99, 235, 1);--white:rgba(255, 255, 255, 1);--gray-200:rgba(229, 231, 235, 1);--gray-500:rgba(107, 114, 128, 1);--gray-800:rgba(31, 41, 55, 1);--black:rgba(0, 0, 0, 1)}*{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.max-w-screen-lg{max-width:1024px}.max-w-screen-md{max-width:768px}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}@media (min-width:1536px){.container{max-width:1536px}}.mx-auto{margin-left:auto;margin-right:auto}.shadow{--tw-shadow:0 1px 3px 0 rgba(0, 0, 0, 0.1),0 1px 2px 0 rgba(0, 0, 0, 0.06);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.rounded{border-radius:.25rem}h2{font-size:var(--size-5);line-height:var(--size-7);margin-left:var(--size-4);margin-top:var(--size-6)}@media (min-width:1024px){h2{font-size:var(--size-6);line-height:var(--size-8)}}h3{font-size:var(--size-4_5);line-height:var(--size-7);margin-top:var(--size-6);color:var(--gray-800);font-weight:var(--weight-semibold);letter-spacing:-.025em}@media (min-width:1024px){h3{font-size:var(--size-5);line-height:var(--size-7)}}h4{margin-top:var(--size-5);font-weight:var(--weight-semibold)}.icon{width:var(--size-5);height:var(--size-5);margin-bottom:var(--size-1);display:inline}.tag{padding-right:var(--size-3);white-space:nowrap}pre{border-radius:var(--size-1)}ul{list-style:disc;padding-left:var(--size-4_5)}ol{list-style:decimal;padding-left:var(--size-4_5)}blockquote{margin-top:1rem;padding-left:1rem;border-left:4px solid #dadada}th{text-align:start;font-weight:var(--weight-bitbold)}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:0 0;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.header h1{margin-top:0;font-size:var(--size-4_5);line-height:var(--size-7)}@media(min-width:1024px){.header h1{font-size:var(--size-5)}}.sub{font-size:var(--size-4);line-height:var(--size-6);font-weight:var(--weight-extralight);height:var(--size-6)}.sub span{animation:fade 10s linear infinite 0s;opacity:0;overflow:hidden;position:absolute}.sub span:nth-child(2){animation-delay:2.5s}.sub span:nth-child(3){animation-delay:5s}.sub span:nth-child(4){animation-delay:7.5s}@media(min-width:1024px){.sub{font-size:var(--size-4_5);line-height:var(--size-7)}}@keyframes fade{0%{opacity:0}5%{opacity:0}10%{opacity:1}25%{opacity:1}30%{opacity:0}100%{opacity:0}}.outer{margin-top:var(--size-8);background-color:var(--blue-600);transform:skewY(6deg);width:66.666667%;max-width:var(--size-xs);min-width:-webkit-min-content;min-width:min-content}@media(min-width:1024px){.outer{max-width:var(--size-md)}}.inner{padding:var(--size-2);background-color:var(--white);transform:skewY(-6deg);width:80%}header>h1{font-size:var(--size-6);line-height:var(--size-8);margin-top:var(--size-7)}@media(min-width:1024px){header>h1{font-size:var(--size-7);line-height:var(--size-9)}}h1,h2,h3,h4,h5,h6{margin-left:0}.content{max-width:768px;margin-top:var(--size-6);padding-right:var(--size-5);padding-left:var(--size-5)}.text{margin-top:var(--size-2);font-size:var(--size-4)}.text p{padding-top:var(--size-4)}.text a{color:var(--blue-600)}.text a:hover{text-decoration:underline}.text pre{margin-top:var(--size-1);margin-bottom:var(--size-1)}.text table{table-layout:auto;width:100%;margin-top:var(--size-2);margin-bottom:var(--size-2)}.text tr{border-bottom-width:1px}.text td{padding:var(--size-1_5)}:not(a)>code{border-radius:var(--size-1);padding:var(--size-0_5);background-color:var(--gray-200)}.text blockquote>p{padding-top:0}footer{padding-top:var(--size-4);padding-bottom:var(--size-2);width:100%;text-align:center}
        </style>
        <link rel="stylesheet" href="../prism-okaidia.min.css">
        <link rel="stylesheet" href="../katex.min.css">
    </head>
    <body>
        <a href="/" class="header">
            <div class="outer shadow rounded mx-auto">
                <div class="inner shadow rounded mx-auto">
                    <header>
                        <h1>Nicolas Portmann</h1>
                        <div class="sub">
                            <span>Software Engineering</span>
                            <span>Security Engineering</span>
                            <span>Applied Cryptography</span>
                            <span>Performance Optimization</span>
                        </div>
                    </header>
                </div>
            </div>
        </a>
        <div class="content container mx-auto">
            <main>
                <header>
                    <h1>Running Chrome in Docker for CI/CD</h1>
                    
                    
    <section>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <span class="meta">2019/09/30</span>
        </span>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <span class="meta">Nicolas Portmann</span>
        </span>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0
                        014-4z"></path>
            </svg>
            <span class="meta">Web Dev</span>
        </span>
    </section>

                </header>
                <article class="text">
                    <p>Running Chrome headless in Docker turns out to be surprisingly hard. Many resources on the internet suggest to disable the sandbox, and everything works fine. <strong>Please don't trust random people on the internet, telling you to disable security features</strong>.</p>
<p>Ask yourself the following: Do you really trust all the, let's say <strong>18847 packages</strong> that are included with a barebones <code>ng new</code> Angular application to run outside a sandbox? I sure don't.</p>
<p><strong><code>Tl;dr</code></strong> Checkout the <a href="https://github.com/tkp1n/chromium-ci/blob/master/README.md" title="README - chromium-ci - GitHub">README</a> of <code>tkp1n/chromium</code> to get started.</p>
<p>As you've decided to skip the short version, let's start with why you want to run Chrome in Docker in the first place.</p>
<h2>Rationale</h2>
<p>Testing web applications is typically done within a browser. I use Chrome to test the Angular app I'm working on at the moment. Naturally, I want to execute those tests as part of the CI/CD pipeline of the project as well. That's is where things get tricky. The easiest would be to install Chrome on the build server. That is what you get if you make use of <a href="https://github.com/features/actions" title="Actions - GitHub">GitHub Actions</a> or any other decent public CI/CD service.</p>
<p>Unfortunately, not everything is developed in the open and convincing corporate IT to install Chrome on all their build servers may not be manageable. One could even argue that it isn't desirable in the first place. Consider this: I might want to test my project using a different version of Chrome than some other team. Docker makes a compelling argument both to avoid lengthy discussions with corporate IT and to get reproducible builds using the exact versions of the tools I prefer.</p>
<p>Two years ago, I would have likely used <a href="https://phantomjs.org/" title="PhantomJS.org">PhantomJS</a> to run automated front-end tests on a server. However, as the project is discontinued, we have to look at alternatives. The more or less drop-in replacement would be <a href="https://github.com/GoogleChrome/puppeteer" title="puppeteer - GoogleChrome - GitHub">Puppeteer</a> by Google. Unfortunately, Puppeteer isn't exactly plug-and-play as several dependencies to run Chrome may be missing on the target system and they do not get installed with Puppeteer. As it turns out, Puppeteer isn't even needed to test an Angular app on a build server. All you need is a working installation of Chromium and some command-line options.</p>
<h2>The Docker image</h2>
<p>I assembled a <a href="https://github.com/tkp1n/chromium-ci/blob/master/Dockerfile" title="Dockerfile - chromium-ci - GitHub">Dockerfile</a> on the foundation of <a href="https://www.alpinelinux.org/" title="Alpine Linux">Alpine Linux</a>, one of the smallest base images available. It uses the edge channel, as Chromium &gt; 76 is required for things to run smoothly and it isn't yet in one of the stable versions. Luckily it is a matter of time until we can use the standard Alpine base image. The only things installed are Chromium (as well as it's recommended dependencies), Node.js and npm (to execute the tests) as well as dumb-init (explained later). A user <code>chromium</code> is created and switched to, ensuring we don't execute Chrome as a privileged user. <code>CHROME_BIN</code> is set to avoid the need for additional configuration in the applications under test (e.g., karma.conf.js), and dumb-init is bootstrapped to avoid zombie processes of Chrome sticking around as proposed by this <a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/troubleshooting.md#tips" title="troubleshooting.md - puppeteer - GoogleChrome - GitHub">troubleshooting section of Puppeteer</a>.</p>
<p>You may think this sounds way too straight-forward to justify a blog post and you'd be right. Sadly, things aren't as easy as they seem. Starting Chrome in the Docker image built by above Dockerfile fails spectacularly with an error similar to this:</p>
<pre class="language-bash"><code class="language-bash">Cannot start ChromeHeadless<br>Failed to move to new namespace: PID namespaces supported, Network namespace supported, but failed: errno <span class="token operator">=</span> Operation not permitted<br><span class="token punctuation">[</span>0929/190238.494297:FATAL:zygote_host_impl_linux.cc<span class="token punctuation">(</span><span class="token number">187</span><span class="token punctuation">)</span><span class="token punctuation">]</span> Check failed: ReceiveFixedMessage<span class="token punctuation">(</span>fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>, kZygoteBootMessage, sizeof<span class="token punctuation">(</span>kZygoteBootMessage<span class="token punctuation">)</span>, <span class="token operator">&amp;</span>boot_pid<span class="token punctuation">)</span>.<br>Received signal <span class="token number">6</span><br>  r8: 00007ffebb72b300  r9: 00007f93224c114c r10: 0000000000000008 r11: 0000000000000246<br> r12: 00007ffebb72b690 r13: 0000000000000000 r14: 00007ffebb72b440 r15: 00000000000000a0<br>  di: 0000000000000002  si: 00007ffebb72adc0  bp: 00007ffebb72adc0  bx: 0000000000000006<br>  dx: 0000000000000000  ax: 0000000000000000  cx: 00007f9322474225  sp: 00007ffebb72ada8<br>  ip: 00007f9322474225 efl: 0000000000000246 cgf: 002b000000000033 erf: 0000000000000000<br> trp: 0000000000000000 msk: 0000000000000000 cr2: 0000000000000000<br><span class="token punctuation">[</span>end of stack trace<span class="token punctuation">]</span><br>Calling _exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>. Core <span class="token function">file</span> will not be generated.</code></pre>
<p>Why is that? Because Chrome uses certain syscalls that usually aren't allowed from within a Docker container: <code>arch_prctl</code> <code>chroot</code> <code>clone</code> <code>fanotify_init</code> <code>name_to_handle_at</code> <code>open_by_handle_at</code> <code>setdomainname</code> <code>sethostname</code> <code>syslog</code> <code>unshare</code> <code>vhangup</code> <code>setns</code> <a href="https://github.com/docker/for-linux/issues/496#issuecomment-441149510" title="Issue #496 docker - GitHub">(source)</a>.</p>
<h2>Convincing Chrome to actually start</h2>
<p>We have 4 different options to get things working again:</p>
<ol>
<li><strong>We disable the sandbox.</strong> This method defeats the entire purpose of this exercise. <em>Don't do that.</em></li>
<li><strong>We start the Docker container with</strong> <code>--privileged</code><strong>.</strong> This way, our tests are sandboxed, but the security policies enforced by Docker are entirely disabled. <em>Don't do that either.</em></li>
<li><strong>We start the Docker container with</strong> <code>--cap-add=SYS_ADMIN</code><strong>.</strong> This approach is better than the above but still not perfect. It enables CAP_SYS_ADMIN capabilities, which usually are not granted. See <a href="http://man7.org/linux/man-pages/man7/capabilities.7.html" title="capabilities - man pages">capabilities(7)</a> for more detail. The <a href="https://github.com/GoogleChrome/puppeteer/blob/master/docs/troubleshooting.md" title="Troubleshooting.md - puppeteer - GoogleChrome - GitHub">Puppeteer troubleshooting guide</a> suggests this option as well. <em>Do this only, if below option does not work for you.</em></li>
<li><strong>We provide a custom seccomp</strong>. Starting the container with <code>--security-opt seccomp=chrome.json</code> allows us to provide a JSON file with an exact whitelist of syscalls required by Chrome. We can run the browser sandbox and still prevent anything inside the container to go rouge - <em>My personal favorite.</em></li>
</ol>
<p>The <code>chrome.json</code> I am referring to in option 4 can be found <a href="https://github.com/tkp1n/chromium-ci/blob/master/seccomp/chromium.json" title="chromium.json - chromium-ci - GitHub">here</a>. It is based on the <a href="https://raw.githubusercontent.com/moby/moby/master/profiles/seccomp/default.json" title="default.json - moby - GitHub">default seccomp profile from the moby repository</a> and the whitelist contained in the profile is extended with the syscalls mentioned above.</p>
<p>The Docker documentation gives a good starting point for additional information on the <a href="https://docs.docker.com/engine/security/seccomp/" title="seccomp - Docker.com">seccomp security profiles</a>. There is even a 20-minute <a href="https://github.com/docker/labs/tree/master/security/seccomp" title="seccomp - docker - GitHub">lab</a> in which you can learn how to figure out what syscalls are missing from the default seccomp profile.</p>
<h2>What we've achieved</h2>
<p>With the Docker image <code>tkp1n/chromium</code> and some tweaking - preferably by setting the extended seccomp profile as shown in the sample below - we can test an angular app on any CI/CD server that runs Docker. Without installing anything or setting Chrome into a dangerous mode.</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">docker</span> run<br>    --security-opt <span class="token assign-left variable">seccomp</span><span class="token operator">=</span>seccomp/chromium.json<br>    -v <span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span>/node-ci-demo:/app<br>    tkp1n/chromium<br>    <span class="token function">npm</span> run <span class="token builtin class-name">test</span> -- --no-watch --browsers<span class="token operator">=</span>ChromeHeadless</code></pre>
<p>Also make sure to checkout the <a href="https://github.com/tkp1n/chromium-ci/blob/master/README.md" title="README.md - chromium-ci - GitHub">README</a> of <code>tkp1n/chromium</code> to get started.</p>

                </article>
            </main>
        </div>
        <footer>
            <p>&#169; Nicolas Portmann</p>
        </footer>
    </body>
</html>