<!DOCTYPE html><!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>An io_uring based Transport Layer (Part III) - Preview Release</title>
        <meta name="description" content="A Software Engineering Blog">
        <meta property="og:url" content="https://ndportmann.com/io_uring-preview-release/">
        <meta property="og:title" content="An io_uring based Transport Layer (Part III) - Preview Release">
        <meta property="og:description" content="A blog about software engineering and applied cryptography.">
        <meta property="og:type" content="article">
        <meta name="twitter:site" content="@tkp1n">
        <meta name="twitter:creator" content="@tkp1n">
        <meta name="twitter:card" content="summary">
        <style>
            
            /*! tailwindcss v2.1.1 | MIT License | https://tailwindcss.com *//*! modern-normalize v1.0.0 | MIT License | https://github.com/sindresorhus/modern-normalize */*,::after,::before{box-sizing:border-box}:root{-moz-tab-size:4;tab-size:4}html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji'}hr{height:0;color:inherit}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset{margin:0;padding:0}ol,ul{list-style:none;margin:0;padding:0}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}body{font-family:inherit;line-height:inherit}*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}:root{--size-0_5:0.125rem;--size-1:0.250rem;--size-1_5:0.375rem;--size-2:0.5rem;--size-3:0.75rem;--size-3_5:0.875rem;--size-4:1rem;--size-4_5:1.125rem;--size-5:1.25rem;--size-6:1.5rem;--size-7:1.75rem;--size-7_5:1.875rem;--size-8:2rem;--size-9:2.25rem;--size-10:2.5rem;--size-xs:20rem;--size-md:28rem;--weight-extralight:200;--weight-light:300;--weight-bitbold:400;--weight-semibold:600;--blue-500:rgba(59, 130, 246, 1);--blue-600:rgba(37, 99, 235, 1);--blue-800:rgba(37, 99, 235, 1);--white:rgba(255, 255, 255, 1);--gray-200:rgba(229, 231, 235, 1);--gray-500:rgba(107, 114, 128, 1);--gray-800:rgba(31, 41, 55, 1);--black:rgba(0, 0, 0, 1)}*{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.max-w-screen-lg{max-width:1024px}.max-w-screen-md{max-width:768px}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}@media (min-width:1536px){.container{max-width:1536px}}.mx-auto{margin-left:auto;margin-right:auto}.shadow{--tw-shadow:0 1px 3px 0 rgba(0, 0, 0, 0.1),0 1px 2px 0 rgba(0, 0, 0, 0.06);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.rounded{border-radius:.25rem}h2{font-size:var(--size-5);line-height:var(--size-7);margin-left:var(--size-4);margin-top:var(--size-6)}@media (min-width:1024px){h2{font-size:var(--size-6);line-height:var(--size-8)}}h3{font-size:var(--size-4_5);line-height:var(--size-7);margin-top:var(--size-6);color:var(--gray-800);font-weight:var(--weight-semibold);letter-spacing:-.025em}@media (min-width:1024px){h3{font-size:var(--size-5);line-height:var(--size-7)}}h4{margin-top:var(--size-5);font-weight:var(--weight-semibold)}.icon{width:var(--size-5);height:var(--size-5);margin-bottom:var(--size-1);display:inline}.tag{padding-right:var(--size-3);white-space:nowrap}pre{border-radius:var(--size-1)}ul{list-style:disc;padding-left:var(--size-4_5)}ol{list-style:decimal;padding-left:var(--size-4_5)}blockquote{margin-top:1rem;padding-left:1rem;border-left:4px solid #dadada}th{text-align:start;font-weight:var(--weight-bitbold)}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:0 0;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.header h1{margin-top:0;font-size:var(--size-4_5);line-height:var(--size-7)}@media(min-width:1024px){.header h1{font-size:var(--size-5)}}.sub{font-size:var(--size-4);line-height:var(--size-6);font-weight:var(--weight-extralight);height:var(--size-6)}.sub span{animation:fade 10s linear infinite 0s;opacity:0;overflow:hidden;position:absolute}.sub span:nth-child(2){animation-delay:2.5s}.sub span:nth-child(3){animation-delay:5s}.sub span:nth-child(4){animation-delay:7.5s}@media(min-width:1024px){.sub{font-size:var(--size-4_5);line-height:var(--size-7)}}@keyframes fade{0%{opacity:0}5%{opacity:0}10%{opacity:1}25%{opacity:1}30%{opacity:0}100%{opacity:0}}.outer{margin-top:var(--size-8);background-color:var(--blue-600);transform:skewY(6deg);width:66.666667%;max-width:var(--size-xs);min-width:-webkit-min-content;min-width:min-content}@media(min-width:1024px){.outer{max-width:var(--size-md)}}.inner{padding:var(--size-2);background-color:var(--white);transform:skewY(-6deg);width:80%}header>h1{font-size:var(--size-6);line-height:var(--size-8);margin-top:var(--size-7)}@media(min-width:1024px){header>h1{font-size:var(--size-7);line-height:var(--size-9)}}h1,h2,h3,h4,h5,h6{margin-left:0}.content{max-width:768px;margin-top:var(--size-6);padding-right:var(--size-5);padding-left:var(--size-5)}.text{margin-top:var(--size-2);font-size:var(--size-4)}.text p{padding-top:var(--size-4)}.text a{color:var(--blue-600)}.text a:hover{text-decoration:underline}.text pre{margin-top:var(--size-1);margin-bottom:var(--size-1)}.text table{table-layout:auto;width:100%;margin-top:var(--size-2);margin-bottom:var(--size-2)}.text tr{border-bottom-width:1px}.text td{padding:var(--size-1_5)}:not(a)>code{border-radius:var(--size-1);padding:var(--size-0_5);background-color:var(--gray-200)}.text blockquote>p{padding-top:0}footer{padding-top:var(--size-4);padding-bottom:var(--size-2);width:100%;text-align:center}
        </style>
        <link rel="stylesheet" href="../prism-okaidia.min.css">
        <link rel="stylesheet" href="../katex.min.css">
    </head>
    <body>
        <a href="/" class="header">
            <div class="outer shadow rounded mx-auto">
                <div class="inner shadow rounded mx-auto">
                    <header>
                        <h1>Nicolas Portmann</h1>
                        <div class="sub">
                            <span>Software Engineering</span>
                            <span>Security Engineering</span>
                            <span>Applied Cryptography</span>
                            <span>Performance Optimization</span>
                        </div>
                    </header>
                </div>
            </div>
        </a>
        <div class="content container mx-auto">
            <main>
                <header>
                    <h1>An io_uring based Transport Layer (Part III) - Preview Release</h1>
                    
                    
    <section>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <span class="meta">2020/06/08</span>
        </span>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <span class="meta">Nicolas Portmann</span>
        </span>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0
                        014-4z"></path>
            </svg>
            <span class="meta">io_uring</span>
        </span>
    </section>

                </header>
                <article class="text">
                    <p>Round 19 of the TechEmpower Benchmarks just completed, and ASP.NET <a href="https://www.techempower.com/benchmarks/#section=data-r19&amp;hw=ph&amp;test=plaintext" title="Plaintext - Run 19 - TechEmpower Benchmarks">topped the charts</a> for the &quot;Plaintext&quot; type of tests. In fact, quite a few platforms are able to <a href="https://www.ageofascent.com/2019/02/04/asp-net-core-saturating-10gbe-at-7-million-requests-per-second/" title="ASP.NET CORE: SATURATING 10GBE AT 7+ MILLION REQUEST/S - ageofascent.com">saturate 10GbE at 7+ million request/s</a>, which could lead us to think that there is no room for improvements. I beg to differ.</p>
<p>A new set of APIs for I/O in the Linux Kernel called <code>io_uring</code> promise to improve things once again significantly, as detailed in the previous parts (<a href="https://ndportmann.com/io_uring-rationale/" title="io_uring Rationale - ndportmann.com">I</a> and <a href="https://ndportmann.com/io_uring-foundation/" title="io_uring Foundation - ndportmann.com">II</a>) of this series. <code>io_uring</code> was introduced in version 5.1 of the kernel, and its capabilities have <a href="https://lwn.net/Articles/810414/" title="The rapid growth of io_uring - lwn.net">grown rapidly</a> over the past releases. Unfortunately, the performance and features required to compete in the webserver business came shortly after the current longterm kernel release v5.4. But the long-awaited features are here now (in stable releases) and worth taking a look at.</p>
<p>Over the last couple of months, we've developed a new Transport Layer for ASP.NET based on <code>io_uring</code> called <a href="https://github.com/tkp1n/IoUring.Transport" title="IoUring.Transport - GitHub"><strong>IoUring.Transport</strong></a>, which is now available as a preview release on <a href="https://www.nuget.org/packages/IoUring.Transport" title="IoUring.Transport - NuGet">NuGet.org</a>. In this post, we look at initial benchmark results and close with some thoughts about the future.</p>
<h2>Benchmark Results</h2>
<h3>Methodology</h3>
<p>All benchmarks were conducted on my notebook (Lenovo X1 Extreme Gen 2: Intel i7-9750H (6 Core / 12 Thread) with 32 GB RAM) running Windows 10 (2004). Both the load generator (<code>wrk</code>) and the web servers were run in the same Ubuntu Server 20.04 Hyper-V VM with 12 logical cores and 8 GB of RAM assigned.</p>
<p>The load tests executed for 10 minutes per configuration using 128 concurrent connections over 6 threads:</p>
<pre><code>wrk -t 6 -c 128 -d 600s http://localhost:8080/p
</code></pre>
<p>The configurations under test are a fork of the ASP.NET <a href="https://github.com/TechEmpower/FrameworkBenchmarks/tree/master/frameworks/CSharp/aspnetcore/PlatformBenchmarks" title="PlatformBenchmarks - TechEmpower - GitHub">PlatformBenchmarks</a> from the TechEmpower repository adjusted to include the <code>io_uring</code> based Transport Layer (<a href="https://github.com/tkp1n/IoUring.Transport/tree/master/tests/PlatformBenchmarks" title="PlatformBenchmarks - IoUring.Transport - GitHub">see here</a>). The .NET runtime for all configurations is: 5.0.100-preview.4.20258.7.</p>
<p>I am aware that this setup is far from optimal, but I currently don't have the resources (e.g., a 10GbE switch) to perform more real-world testing. Feel free to suggest improvements or to help out at this <a href="https://github.com/tkp1n/IoUring.Transport/issues/5" title="IoUring.Transport - Issue #5 - GitHub">GitHub Issue</a>.</p>
<h3>Results</h3>
<p>Using above methodology, six configurations have been tested:</p>
<ul>
<li><strong>Socket-based Transport Layer</strong> on <strong>v5.7.0</strong></li>
<li><strong>RedHat Transport Layer</strong> (rhtx) on <strong>v5.7.0</strong></li>
<li><strong>IoUring.Transport</strong> on <strong>v5.4.44</strong></li>
<li><strong>IoUring.Transport</strong> on <strong>v5.5.19</strong></li>
<li><strong>IoUring.Transport</strong> on <strong>v5.6.16</strong></li>
<li><strong>IoUring.Transport</strong> on <strong>v5.7.0</strong></li>
</ul>
<p>The results displayed in the charts below show quite interesting findings:</p>
<ul>
<li>Using <code>io_uring</code> on kernels prior to v5.5 is <strong>not profitable</strong> for this scenario.</li>
<li>On v5.7, <code>io_uring</code> delivers <strong>23% more throughput and 74% less latency</strong> than the current TechEmpower chart-topper &quot;aspcore-rhtx&quot;.</li>
<li>The throughput seems bottlenecked at roughly 435000 rps, as I would have expected another jump from v5.6 to v5.7 due to <a href="https://git.kernel.dk/cgit/linux-block/commit/?h=for-5.7/io_uring&amp;id=d7718a9d25a61442da8ee8aeeff6a0097f0ccfd6" title="IORING_FEAT_FAST_POLL - Linux Kernel">IORING_FEAT_FAST_POLL</a> (as seen <a href="https://twitter.com/hielkedv/status/1234135064323280897?s=21" title="hielkedv - Twitter">here</a>).</li>
</ul>
<p><picture><source type="image/avif" srcset="/img/PQwwRfdX6K-300.avif 300w, /img/PQwwRfdX6K-600.avif 600w, /img/PQwwRfdX6K-982.avif 982w" sizes="766px"><source type="image/webp" srcset="/img/PQwwRfdX6K-300.webp 300w, /img/PQwwRfdX6K-600.webp 600w, /img/PQwwRfdX6K-982.webp 982w" sizes="766px"><source type="image/jpeg" srcset="/img/PQwwRfdX6K-300.jpeg 300w, /img/PQwwRfdX6K-600.jpeg 600w, /img/PQwwRfdX6K-982.jpeg 982w" sizes="766px"><img alt="Benchmark Results" loading="lazy" decoding="async" src="/img/PQwwRfdX6K-300.jpeg" width="982" height="853"></picture></p>
<h2>The Future</h2>
<h3>Connection Abstractions in the BCL</h3>
<p>IoUring.Transport is based on the connection abstractions from ASP.NET (<a href="https://github.com/dotnet/aspnetcore/tree/master/src/Servers/Connections.Abstractions/src" title="Connections.Abstractions - AspNetCore - GitHub">Microsoft.AspNetCore.Connections.Abstractions</a>). This means that all frameworks based on <a href="https://github.com/dotnet/aspnetcore/issues/4772" title="Issue #4772 - AspNetCore - GitHub">&quot;Project Bedrock&quot;</a> (ASP.NET, Orleans, etc.) could profit from <code>io_uring</code>. There is currently an <a href="https://github.com/dotnet/runtime/issues/1793" title="Issue #1793 - runtime - dotnet - GitHub">API review</a> ongoing for integrating those abstractions into the base class library. This would mean that any .NET application could profit form IoUring.Transport e.g., to perform HTTP calls at peak performance. I will migrate IoUring.Transport to the BCL connection abstractions, as soon as they are finalized and used by ASP.NET.</p>
<h3>Leveraging Buffer Selection</h3>
<p>Buffer selection is a feature introduced to <code>io_uring</code> in version 5.7. It lets you provide a set of buffers to the kernel and then start <code>read</code> operations without specifying a buffer for the data to be read. Once data is available, the kernel will select one of the previously provided buffers to fulfill the <code>read</code> operation and let you know which buffer it chose. This way, you don't have to &quot;block&quot; one buffer per pending read operation that may not complete at all or only once the remote station has something to say.</p>
<p><a href="https://twitter.com/hielkedv/status/1235223155666542594" title="hielkedv - Twitter">Initial tests have shown</a> that this feature - in its current state - is hurting the performance of web server scenarios quite a bit. I'll look into leveraging it in IoUring.Transport, once this has improved kernel-side.</p>
<p>From my understanding, this feature is meant to reduce the amount of actively used memory and not a feature to improve throughput (directly). It will therefore likely remain behind a feature flag, once it is implemented in IoUring.Transport.</p>
<h3>TechEmpower Benchmarks</h3>
<p>It'll take some time until the servers used by the TechEmpower Benchmarks run a kernel &gt;= v5.7. Don't expect to see results using this Transport layer anytime soon. But help is always appreciated to make sure we are ready with an <code>io_uring</code> based Transport, once the TechEmpower servers are ready. We don't want to fall behind, now that we are on top, do we? ðŸ˜‰</p>
<h3>Try it for Yourself!</h3>
<p>As mentioned above, IoUring.Transport is now available as a preview release on <a href="https://www.nuget.org/packages/IoUring.Transport" title="IoUring.Transport - NuGet">NuGet.org</a>. The entire project is open source, and I'd love to hear your feedback on <a href="https://github.com/tkp1n/IoUring.Transport" title="IoUring.Transport - GitHub">GitHub</a>.</p>
<p>Be aware, though, that this is a preview release of an experiment. Do <strong>not</strong> use this in production (yet).</p>
<h3>Comments</h3>
<p>If you want to leave a comment about this blog post, please do so on <a href="https://github.com/tkp1n/ndportmann.com/issues/2" title="Issue #2 - ndportmann.com">this</a> GitHub issue. I plan to - at some time - add a comment section to this blog. For now, <a href="https://github.com/tkp1n/ndportmann.com/issues/2" title="Issue #2 - ndportmann.com">this issue</a> is all we have.</p>

                </article>
            </main>
        </div>
        <footer>
            <p>&#169; Nicolas Portmann</p>
        </footer>
    </body>
</html>