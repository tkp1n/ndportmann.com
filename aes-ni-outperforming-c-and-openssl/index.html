<!DOCTYPE html><!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AES-NI (.NET) - Outperforming C and OpenSSL</title>
        <meta name="description" content="A Software Engineering Blog">
        <meta property="og:url" content="https://ndportmann.com/aes-ni-outperforming-c-and-openssl/">
        <meta property="og:title" content="AES-NI (.NET) - Outperforming C and OpenSSL">
        <meta property="og:description" content="A blog about software engineering and applied cryptography.">
        <meta property="og:type" content="article">
        <meta name="twitter:site" content="@tkp1n">
        <meta name="twitter:creator" content="@tkp1n">
        <meta name="twitter:card" content="summary">
        <style>
            
            /*! tailwindcss v2.1.1 | MIT License | https://tailwindcss.com *//*! modern-normalize v1.0.0 | MIT License | https://github.com/sindresorhus/modern-normalize */*,::after,::before{box-sizing:border-box}:root{-moz-tab-size:4;tab-size:4}html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji'}hr{height:0;color:inherit}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset{margin:0;padding:0}ol,ul{list-style:none;margin:0;padding:0}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}body{font-family:inherit;line-height:inherit}*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}:root{--size-0_5:0.125rem;--size-1:0.250rem;--size-1_5:0.375rem;--size-2:0.5rem;--size-3:0.75rem;--size-3_5:0.875rem;--size-4:1rem;--size-4_5:1.125rem;--size-5:1.25rem;--size-6:1.5rem;--size-7:1.75rem;--size-7_5:1.875rem;--size-8:2rem;--size-9:2.25rem;--size-10:2.5rem;--size-xs:20rem;--size-md:28rem;--weight-extralight:200;--weight-light:300;--weight-bitbold:400;--weight-semibold:600;--blue-500:rgba(59, 130, 246, 1);--blue-600:rgba(37, 99, 235, 1);--blue-800:rgba(37, 99, 235, 1);--white:rgba(255, 255, 255, 1);--gray-200:rgba(229, 231, 235, 1);--gray-500:rgba(107, 114, 128, 1);--gray-800:rgba(31, 41, 55, 1);--black:rgba(0, 0, 0, 1)}*{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.max-w-screen-lg{max-width:1024px}.max-w-screen-md{max-width:768px}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}@media (min-width:1536px){.container{max-width:1536px}}.mx-auto{margin-left:auto;margin-right:auto}.shadow{--tw-shadow:0 1px 3px 0 rgba(0, 0, 0, 0.1),0 1px 2px 0 rgba(0, 0, 0, 0.06);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.rounded{border-radius:.25rem}h2{font-size:var(--size-5);line-height:var(--size-7);margin-left:var(--size-4);margin-top:var(--size-6)}@media (min-width:1024px){h2{font-size:var(--size-6);line-height:var(--size-8)}}h3{font-size:var(--size-4_5);line-height:var(--size-7);margin-top:var(--size-6);color:var(--gray-800);font-weight:var(--weight-semibold);letter-spacing:-.025em}@media (min-width:1024px){h3{font-size:var(--size-5);line-height:var(--size-7)}}h4{margin-top:var(--size-5);font-weight:var(--weight-semibold)}.icon{width:var(--size-5);height:var(--size-5);margin-bottom:var(--size-1);display:inline}.tag{padding-right:var(--size-3);white-space:nowrap}pre{border-radius:var(--size-1)}ul{list-style:disc;padding-left:var(--size-4_5)}ol{list-style:decimal;padding-left:var(--size-4_5)}blockquote{margin-top:1rem;padding-left:1rem;border-left:4px solid #dadada}th{text-align:start;font-weight:var(--weight-bitbold)}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:0 0;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.header h1{margin-top:0;font-size:var(--size-4_5);line-height:var(--size-7)}@media(min-width:1024px){.header h1{font-size:var(--size-5)}}.sub{font-size:var(--size-4);line-height:var(--size-6);font-weight:var(--weight-extralight);height:var(--size-6)}.sub span{animation:fade 10s linear infinite 0s;opacity:0;overflow:hidden;position:absolute}.sub span:nth-child(2){animation-delay:2.5s}.sub span:nth-child(3){animation-delay:5s}.sub span:nth-child(4){animation-delay:7.5s}@media(min-width:1024px){.sub{font-size:var(--size-4_5);line-height:var(--size-7)}}@keyframes fade{0%{opacity:0}5%{opacity:0}10%{opacity:1}25%{opacity:1}30%{opacity:0}100%{opacity:0}}.outer{margin-top:var(--size-8);background-color:var(--blue-600);transform:skewY(6deg);width:66.666667%;max-width:var(--size-xs);min-width:-webkit-min-content;min-width:min-content}@media(min-width:1024px){.outer{max-width:var(--size-md)}}.inner{padding:var(--size-2);background-color:var(--white);transform:skewY(-6deg);width:80%}header>h1{font-size:var(--size-6);line-height:var(--size-8);margin-top:var(--size-7)}@media(min-width:1024px){header>h1{font-size:var(--size-7);line-height:var(--size-9)}}h1,h2,h3,h4,h5,h6{margin-left:0}.content{max-width:768px;margin-top:var(--size-6);padding-right:var(--size-5);padding-left:var(--size-5)}.text{margin-top:var(--size-2);font-size:var(--size-4)}.text p{padding-top:var(--size-4)}.text a{color:var(--blue-600)}.text a:hover{text-decoration:underline}.text pre{margin-top:var(--size-1);margin-bottom:var(--size-1)}.text table{table-layout:auto;width:100%;margin-top:var(--size-2);margin-bottom:var(--size-2)}.text tr{border-bottom-width:1px}.text td{padding:var(--size-1_5)}:not(a)>code{border-radius:var(--size-1);padding:var(--size-0_5);background-color:var(--gray-200)}.text blockquote>p{padding-top:0}footer{padding-top:var(--size-4);padding-bottom:var(--size-2);width:100%;text-align:center}
        </style>
        <link rel="stylesheet" href="../prism-okaidia.min.css">
        <link rel="stylesheet" href="../katex.min.css">
    </head>
    <body>
        <a href="/" class="header">
            <div class="outer shadow rounded mx-auto">
                <div class="inner shadow rounded mx-auto">
                    <header>
                        <h1>Nicolas Portmann</h1>
                        <div class="sub">
                            <span>Software Engineering</span>
                            <span>Security Engineering</span>
                            <span>Applied Cryptography</span>
                            <span>Performance Optimization</span>
                        </div>
                    </header>
                </div>
            </div>
        </a>
        <div class="content container mx-auto">
            <main>
                <header>
                    <h1>AES-NI (.NET) - Outperforming C and OpenSSL</h1>
                    
                    
    <section>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <span class="meta">2019/04/08</span>
        </span>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <span class="meta">Nicolas Portmann</span>
        </span>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0
                        014-4z"></path>
            </svg>
            <span class="meta">Crypto</span>
        </span>
    </section>

                </header>
                <article class="text">
                    <blockquote>
<p>This is the third and last post of a small series on AES-NI and .NET Core hardware intrinsics. Please also have a look at the <a href="https://ndportmann.com/improving-dotnet-crypto-code/" title="Improving .NET Crypto Code - ndportmann.com">first post</a> and the <a href="https://ndportmann.com/aes-ni-key-expansion/" title="AES-NI Key Expansion - ndportmann.com">second post</a>.</p>
</blockquote>
<h2>The challenge</h2>
<pre><code>We have a message for you.
It’s 3ncryp73d and we want you to crack it.
The decrypted message will contain further instructions.

Knowns:
- The algorithm is AES (Rijndael)
- Blocksize: 128
- Keysize: 256
- You only need to find the first 6 bytes of the key, the rest are 0’s, so:
    [?,?,?,?,?,?,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
- All bytes in the key has an integer value between 0 and 16.
- The initialization vector is (base64 encoded): &quot;DkBbcmQo1QH+ed1wTyBynA==&quot;
- The text is just plain ASCII english

The encrypted text (base64 encoded):

yptyoDdVBdQtGhgoePppYHnWyugGmy0j81sf3zBeUXEO/LYRw+2XmVa0/v6YiSy9Kj8gMn/gNu2I7dPmfgSEHPUDJpNpiOWmmW1/jw/Pt29Are5tumWmnfkazcAb23xe7B4ruPZVxUEhfn/IrZPNZdr4cQNrHNgEv2ts8gVFuOBU+p792UPy8/mEIhW5ECppxGIb7Yrpg4w7IYNeFtX5d9W4W1t2e+6PcdcjkBK4a8y1cjEtuQ07RpPChOvLcSzlB/Bg7UKntzorRsn+y/d72qD2QxRzcXgbynCNalF7zaT6pEnwKB4i05fTQw6nB7SU1w2/EvCGlfiyR2Ia08mA0GikqegYA6xG/EAGs3ZJ0aQUGt0YZz0P7uBsQKdmCg7jzzEMHyGZDNGTj0F2dOFHLSOTT2/GGSht8eD/Ae7u/xnJj0bGgAKMtNttGFlNyvKpt2vDDT3Orfk6Jk/rD4CIz6O/Tnt0NkJLucHtIyvBYGtQR4+mhbfUELkczeDSxTXGDLaiU3de6tPaa0/vjzizoUbNFdfkIly/HWINdHoO83E=

Trustpilot Development Team

Biting the red pill
</code></pre>
<blockquote>
<p>Trustpilot: http://followthewhiterabbit.trustpilot.com/challenge2.html</p>
</blockquote>
<h2>73.074 s - A solid baseline</h2>
<p>In the <a href="https://ndportmann.com/improving-dotnet-crypto-code/" title="Improving .NET Crypto Code - ndportmann.com">first post</a> of this series, we analyzed a straightforward implementation of an AES brute-force attack against a known ciphertext. The task at hand requires us to decrypt a given ciphertext with <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><msup><mn>7</mn><mn>6</mn></msup></mrow><annotation encoding="application/x-tex">17^6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8141079999999999em;"></span><span class="strut bottom" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord"><span class="mord mathrm">7</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord mathrm">6</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span> different keys which should yield a human-readable plaintext in roughly <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mrow><mn>1</mn><msup><mn>7</mn><mn>6</mn></msup></mrow><mrow><mn>2</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex">17^6 \over 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.97032em;"></span><span class="strut bottom" style="height:1.3153199999999998em;vertical-align:-0.345em;"></span><span class="base textstyle uncramped"><span class="mord reset-textstyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.345em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">2</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.394em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">1</span><span class="mord"><span class="mord mathrm">7</span><span class="vlist"><span style="top:-0.363em;margin-right:0.07142857142857144em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle uncramped"><span class="mord mathrm">6</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span> operations. To determine whether the plaintext produced by the brute-force attack is human-readable, we search for the string &quot;trust&quot; which we expect to be part of the plaintext.</p>
<p>If all you care about is solving the challenge cited above, <a href="https://github.com/ronnieholm/Playground/blob/012c19b8b6035704e522b4d9a875164ae6f54ac6/TrustpilotAesChallenge/CSharp/Program.cs" title="TrustpilotAesChallenge - ronnieholm - GitHub">this</a> may be the source you come up with, and there is nothing wrong with that. You may, however, be slightly offended when you realize, that the execution time of the referenced C# snippet is more than an order of magnitude slower than its C counterpart. If this is you, then read on. We end up beating the C counterpart (available <a href="https://github.com/ronnieholm/Playground/blob/master/TrustpilotAesChallenge/C/program.c" title="program.c - Playground - ronnieholm - GitHub">here</a>). By a lot!</p>
<p>The source code we started with, looks close to the following snippet.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">Aes</span> Cipher <span class="token operator">=</span> <span class="token comment">// setup of Cipher omitted...</span><br><br><span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">InnerLoop</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> cipherText<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> key<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> iv<span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> decryptor <span class="token operator">=</span> Cipher<span class="token punctuation">.</span><span class="token function">CreateDecryptor</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token class-name"><span class="token keyword">string</span></span> clearText<span class="token punctuation">;</span><br>    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> ms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryStream</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> cs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CryptoStream</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> decryptor<span class="token punctuation">,</span> CryptoStreamMode<span class="token punctuation">.</span>Read<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> sr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StreamReader</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        clearText <span class="token operator">=</span> sr<span class="token punctuation">.</span><span class="token function">ReadToEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> clearText<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token string">"trust"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<blockquote>
<p>Full source: <a href="https://github.com/tkp1n/AesNi/blob/master/AesNi.BruteForce/FwBaseline.cs" title="FwBaseline.cs - AesNi - GitHub">here</a></p>
</blockquote>
<h2>10.702 s - Best bang for the buck</h2>
<p>Analyzing the initial approach to the challenge, we realized that about <strong>85% of the time was spent handling <code>Streams</code> and converting raw bytes to <code>string</code>s</strong>. Transforming the source code to a version which reuses the same <code>byte[]</code> as a target for all decrypt operations was relatively straightforward. Translating the string &quot;trust&quot; to a byte[] with its ASCII values to make use of <code>IndexOf()</code> defined on <code>Span&lt;byte&gt;</code> was easy enough as well. This helps to avoid the conversion of the plaintext to a <code>string</code>.</p>
<p>Using those two optimizations alone, we were able to reduce the runtime from 73s to 11s. The measurements of the <a href="https://ndportmann.com/improving-dotnet-crypto-code/" title="Improving .NET Crypto Code - ndportmann.com">first post</a> showed, that we now use 85% of the time to decrypt and 10% to search for the string &quot;trust&quot;. An excellent reduction of overhead rewarded with <strong>a 6.5x improvement</strong> in runtime.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">Aes</span> Cipher <span class="token operator">=</span> <span class="token comment">// setup of Cipher omitted...</span><br><br><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">ReadOnlySpan<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">></span></span> Trust <span class="token operator">=></span><br>    <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span> <span class="token number">0x74</span><span class="token punctuation">,</span> <span class="token number">0x72</span><span class="token punctuation">,</span> <span class="token number">0x75</span><span class="token punctuation">,</span> <span class="token number">0x73</span><span class="token punctuation">,</span> <span class="token number">0x74</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token return-type class-name"><span class="token keyword">bool</span></span> <span class="token function">InnerLoop</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> cipherText<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> plaintext<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> key<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> iv<span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> decryptor <span class="token operator">=</span> Aes<span class="token punctuation">.</span><span class="token function">CreateDecryptor</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    decryptor<span class="token punctuation">.</span><span class="token function">TransformBlock</span><span class="token punctuation">(</span>cipherText<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cipherText<span class="token punctuation">.</span>Length<span class="token punctuation">,</span> plaintext<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> plaintext<span class="token punctuation">.</span><span class="token function">AsSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IndexOf</span><span class="token punctuation">(</span>Trust<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<blockquote>
<p>Full source: <a href="https://github.com/tkp1n/AesNi/blob/master/AesNi.BruteForce/FwTuned.cs" title="FwTuned.cs - AesNi - GitHub">here</a></p>
</blockquote>
<h2>1.884 s - Flexing the intrinics muscles</h2>
<p>At the end of the <a href="https://ndportmann.com/improving-dotnet-crypto-code/" title="Improving .NET Crypto Code">first post</a>, we realized, that roughly <strong>60% of the total runtime of the above approach is spent creating <code>ICryptoTransform</code> instances</strong> for the ever-changing AES keys in the brute-force code. The <a href="https://ndportmann.com/aes-ni-key-expansion/" title="AES-NI Key Expansion - ndportmann.com">second post</a> focused purely on the AES key expansion using the hardware intrinsics for Intel's AES-NI. With the upcoming 3.0 release of .NET Core, we get direct access to all sorts of hardware intrinsics via the <code>System.Runtime.Intrinsics</code> namespace! The AES key expansion can be implemented almost entirely using the two instructions <code>AESKEYGENASSIST</code> and <code>AESIMC</code> (InverseMixColumns, to calculate the decryption round keys). Check out <a href="https://github.com/tkp1n/AesNi/blob/master/AesNi/Aes128Key.cs" title="Aes128Key.cs - AesNi - GitHub">Aes128Key.cs</a> as an example.</p>
<p>Implementing the AES key expansion in plain C# leveraging the AES-NI instructions (as well as some SSE2 instructions), we were able to calculate the round keys <strong>23x faster</strong> than the time required to create the <code>ICryptoTransform</code> instances in above examples. In the closing words of the <a href="https://ndportmann.com/aes-ni-key-expansion/" title="AES-NI Key Expansion - ndportmann.com">second post</a>, I presented a recipe for turning C/C++ code using Intel intrinsics into C#. Using this recipe, I translated the AES (ECB, CBC, and GCM) from the two Intel white-papers found <a href="https://www.intel.com/content/dam/doc/white-paper/advanced-encryption-standard-new-instructions-set-paper.pdf" title="Aes-NI white paper - Intel">here</a> and <a href="https://software.intel.com/sites/default/files/managed/72/cc/clmul-wp-rev-2.02-2014-04-20.pdf" title="CLMUL white paper - Intel">here</a> into C#. The source code, as well as a bunch of general-purpose benchmarks for it, are available in my <a href="https://github.com/tkp1n/AesNi" title="AesNi - GitHub">AesNi</a> repository.</p>
<p>This AES implementation lets us use the round keys calculated as described in the <a href="https://ndportmann.com/aes-ni-key-expansion/" title="AES-NI Key Expansion - ndportmann.com">second post</a> directly, getting rid of all the framework overhead. To encrypt or decrypt, all round keys are loaded into 128-bit (XMM) registers. The plaintext blocks are also loaded sequentially into 128-bit registers, to be processed togethger with the round keys as the second operand to the  <code>AESENC</code>/<code>AESDEC</code> (and <code>AESENCLAST</code>/<code>AESDECLAST</code>) instructions. The <code>Encrypt</code> method of <a href="https://github.com/tkp1n/AesNi/blob/2cfb5312d2250c386d2a5402b80b58ef660bebf9/AesNi/Aes.128.Cbc.cs#L20" title="Aes.128.Cbc.cs - AesNi - GitHub">Aes.128.Cbc.cs</a> serves as a nice illustration of this procedure. You may notice, that the source code looks a bit weird. This is because arrays and loops are avoided (manually unrolled) to increase the performance of the methods. Unfortunately, .NET Core JIT is (not yet) smart enough to perform those kinds of unrolling.</p>
<p>The results are incredible; we achieve yet <strong>another 5.5x improvement</strong> over the approach above. At this point, we outperform the OpenSSL based brute-force code written in C.</p>
<p>Luckily the task at hand focuses on AES-CBC-256 decryptions, as AES-CBC encryption is one of the few <a href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation" title="Block Cipher Mode of Operation - Wikipedia">modes of operation</a> that cannot be pipelined (parallelized). When pipelining AES operations, we execute multiple <code>AESENC</code>/<code>AESDEC</code> instructions using multiple blocks and the same round key (as seen <a href="https://github.com/tkp1n/AesNi/blob/2cfb5312d2250c386d2a5402b80b58ef660bebf9/AesNi/Aes.128.Cbc.cs#L155" title="Aes.128.Cbc.cs - AesNi - GitHub">here</a>). Those instructions are &quot;data independent&quot; and can be performed in parallel by the CPU (at least to some extent). If you are interested in the optimizations and internals of the AES implementation, give my repository a visit and make sure to read up on <a href="https://mijailovic.net/2018/06/18/aes-armv8/" title="Exploring .NET Core platform intrinsics: Part 2 - Accelerating AES encryption on ARMv8 - mijailovic.net">Nemanja Mijailovic's excellent post</a> on implementing AES for ARMv8, which served as an inspiration for my work.</p>
<blockquote>
<p>Full source: <a href="https://github.com/tkp1n/AesNi/blob/master/AesNi.BruteForce/NiNormal.cs" title="NiNormal.cs - AesNi - GitHub">here</a></p>
</blockquote>
<h2>239 ms - Showing off</h2>
<blockquote>
<p>What can we do when we can’t optimize the single-threaded code any further? We parallelize it!<br>
- <a href="https://adamsitnik.com/Sample-Perf-Investigation/#whats-next" title="Sample Perf Investigation - Adam Sitnik">Adam Sitnik</a></p>
</blockquote>
<p>The brute-force task described above is easily parallelized. We could, for example, spawn 17 threads (0-16), each testing all keys with the first byte fixed to a value from 0-16. Spawning more threads than cores (or more precisely hyper-threads) available on the machine is not profitable as we are directly bound by the hardware performing the AES operations. On a 4-core machine, it would, therefore, be better to spawn 4 threads trying all keys starting with 0-3, 4-7, 8-11, 12-16 respectively with the last thread ending up with a bit more work than the others.</p>
<p>This is exactly what I did <a href="https://github.com/tkp1n/AesNi/blob/master/AesNi.BruteForce/NiParallel.cs" title="NiParallel.cs - AesNi - GitHub">here</a>. I was able to break the ciphertext above in 239ms on my 16-core workstation with a <a href="https://www.amd.com/en/products/cpu/amd-ryzen-threadripper-1950x" title="AMD Ryzen Threadripper 1950X">TR 1950X</a> and in 1.203s on my 2-core MacBook with an <a href="https://ark.intel.com/content/www/us/en/ark/products/91169/intel-core-i7-6660u-processor-4m-cache-up-to-3-40-ghz.html" title="Intel i7-6660u">I7-6660U</a>.</p>
<p>To parallelize the workload, we could have used <code>Parallel.For</code> or one of it's friends from the TPL, but as this series is about removing overhead - not adding it - I decided against it.</p>
<blockquote>
<p>Full source: <a href="https://github.com/tkp1n/AesNi/blob/master/AesNi.BruteForce/NiParallel.cs" title="NiParallel.cs - AesNi - GitHub">here</a></p>
</blockquote>
<h2>Main Takeaways</h2>
<p>This series of blog posts have shown, that .NET Core is an excellent platform for developer productivity. It is straightforward to get things done with relatively few lines of code. If you care about performance, little changes to the existing code are enough to improve things quite drastically. Finally, if every clock cycle matters, there are enough low-level primitives at your disposal, to create a solution capable of outperforming native code.</p>
<p>The essential tips to take away, are:</p>
<ul>
<li>Avoid the use of overhead-heavy constructs (e.g., <code>ICryptoTransform</code>, <code>Stream</code>) on the hot path.</li>
<li>Avoid unnecessary conversions between data formats.</li>
<li>Try to reuse buffers (byte arrays) instead of allocating in loops.</li>
<li>Make use of the frameworks excellent vectorized functions over <code>Span&lt;T&gt;</code>.</li>
<li>If you have the time, invest in utilizing hardware intrinsics for the performance critical percent of your application.</li>
</ul>
<p>Let me close with the benchmark results of the single-shot, cold-start performance of the various methods compared throughout this post.</p>
<table>
<thead>
<tr>
<th>Method</th>
<th style="text-align:right">Workstation</th>
<th style="text-align:right">MacBook</th>
</tr>
</thead>
<tbody>
<tr>
<td>FwOriginal</td>
<td style="text-align:right">73.074 s</td>
<td style="text-align:right">129.432 s</td>
</tr>
<tr>
<td>FwOptimized</td>
<td style="text-align:right">10.702 s</td>
<td style="text-align:right">14.820 s</td>
</tr>
<tr>
<td>AesNiOriginal</td>
<td style="text-align:right">1.884 s</td>
<td style="text-align:right">2.295 s</td>
</tr>
<tr>
<td>AesNiParallel</td>
<td style="text-align:right">0.239 s</td>
<td style="text-align:right">1.203 s</td>
</tr>
</tbody>
</table>

                </article>
            </main>
        </div>
        <footer>
            <p>&#169; Nicolas Portmann</p>
        </footer>
    </body>
</html>