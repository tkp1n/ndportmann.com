<!DOCTYPE html><!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>An io_uring based Transport Layer (Part I) - Rationale</title>
        <meta name="description" content="A Software Engineering Blog">
        <meta property="og:url" content="https://ndportmann.com/io_uring-rationale/">
        <meta property="og:title" content="An io_uring based Transport Layer (Part I) - Rationale">
        <meta property="og:description" content="A blog about software engineering and applied cryptography.">
        <meta property="og:type" content="article">
        <meta name="twitter:site" content="@tkp1n">
        <meta name="twitter:creator" content="@tkp1n">
        <meta name="twitter:card" content="summary">
        <style>
            
            /*! tailwindcss v2.1.1 | MIT License | https://tailwindcss.com *//*! modern-normalize v1.0.0 | MIT License | https://github.com/sindresorhus/modern-normalize */*,::after,::before{box-sizing:border-box}:root{-moz-tab-size:4;tab-size:4}html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji'}hr{height:0;color:inherit}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset{margin:0;padding:0}ol,ul{list-style:none;margin:0;padding:0}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}body{font-family:inherit;line-height:inherit}*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}:root{--size-0_5:0.125rem;--size-1:0.250rem;--size-1_5:0.375rem;--size-2:0.5rem;--size-3:0.75rem;--size-3_5:0.875rem;--size-4:1rem;--size-4_5:1.125rem;--size-5:1.25rem;--size-6:1.5rem;--size-7:1.75rem;--size-7_5:1.875rem;--size-8:2rem;--size-9:2.25rem;--size-10:2.5rem;--size-xs:20rem;--size-md:28rem;--weight-extralight:200;--weight-light:300;--weight-bitbold:400;--weight-semibold:600;--blue-500:rgba(59, 130, 246, 1);--blue-600:rgba(37, 99, 235, 1);--blue-800:rgba(37, 99, 235, 1);--white:rgba(255, 255, 255, 1);--gray-200:rgba(229, 231, 235, 1);--gray-500:rgba(107, 114, 128, 1);--gray-800:rgba(31, 41, 55, 1);--black:rgba(0, 0, 0, 1)}*{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.max-w-screen-lg{max-width:1024px}.max-w-screen-md{max-width:768px}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}@media (min-width:1536px){.container{max-width:1536px}}.mx-auto{margin-left:auto;margin-right:auto}.shadow{--tw-shadow:0 1px 3px 0 rgba(0, 0, 0, 0.1),0 1px 2px 0 rgba(0, 0, 0, 0.06);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.rounded{border-radius:.25rem}h2{font-size:var(--size-5);line-height:var(--size-7);margin-left:var(--size-4);margin-top:var(--size-6)}@media (min-width:1024px){h2{font-size:var(--size-6);line-height:var(--size-8)}}h3{font-size:var(--size-4_5);line-height:var(--size-7);margin-top:var(--size-6);color:var(--gray-800);font-weight:var(--weight-semibold);letter-spacing:-.025em}@media (min-width:1024px){h3{font-size:var(--size-5);line-height:var(--size-7)}}h4{margin-top:var(--size-5);font-weight:var(--weight-semibold)}.icon{width:var(--size-5);height:var(--size-5);margin-bottom:var(--size-1);display:inline}.tag{padding-right:var(--size-3);white-space:nowrap}pre{border-radius:var(--size-1)}ul{list-style:disc;padding-left:var(--size-4_5)}ol{list-style:decimal;padding-left:var(--size-4_5)}blockquote{margin-top:1rem;padding-left:1rem;border-left:4px solid #dadada}th{text-align:start;font-weight:var(--weight-bitbold)}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:0 0;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.header h1{margin-top:0;font-size:var(--size-4_5);line-height:var(--size-7)}@media(min-width:1024px){.header h1{font-size:var(--size-5)}}.sub{font-size:var(--size-4);line-height:var(--size-6);font-weight:var(--weight-extralight);height:var(--size-6)}.sub span{animation:fade 10s linear infinite 0s;opacity:0;overflow:hidden;position:absolute}.sub span:nth-child(2){animation-delay:2.5s}.sub span:nth-child(3){animation-delay:5s}.sub span:nth-child(4){animation-delay:7.5s}@media(min-width:1024px){.sub{font-size:var(--size-4_5);line-height:var(--size-7)}}@keyframes fade{0%{opacity:0}5%{opacity:0}10%{opacity:1}25%{opacity:1}30%{opacity:0}100%{opacity:0}}.outer{margin-top:var(--size-8);background-color:var(--blue-600);transform:skewY(6deg);width:66.666667%;max-width:var(--size-xs);min-width:-webkit-min-content;min-width:min-content}@media(min-width:1024px){.outer{max-width:var(--size-md)}}.inner{padding:var(--size-2);background-color:var(--white);transform:skewY(-6deg);width:80%}header>h1{font-size:var(--size-6);line-height:var(--size-8);margin-top:var(--size-7)}@media(min-width:1024px){header>h1{font-size:var(--size-7);line-height:var(--size-9)}}h1,h2,h3,h4,h5,h6{margin-left:0}.content{max-width:768px;margin-top:var(--size-6);padding-right:var(--size-5);padding-left:var(--size-5)}.text{margin-top:var(--size-2);font-size:var(--size-4)}.text p{padding-top:var(--size-4)}.text a{color:var(--blue-600)}.text a:hover{text-decoration:underline}.text pre{margin-top:var(--size-1);margin-bottom:var(--size-1)}.text table{table-layout:auto;width:100%;margin-top:var(--size-2);margin-bottom:var(--size-2)}.text tr{border-bottom-width:1px}.text td{padding:var(--size-1_5)}:not(a)>code{border-radius:var(--size-1);padding:var(--size-0_5);background-color:var(--gray-200)}.text blockquote>p{padding-top:0}footer{padding-top:var(--size-4);padding-bottom:var(--size-2);width:100%;text-align:center}
        </style>
        <link rel="stylesheet" href="../prism-okaidia.min.css">
        <link rel="stylesheet" href="../katex.min.css">
    </head>
    <body>
        <a href="/" class="header">
            <div class="outer shadow rounded mx-auto">
                <div class="inner shadow rounded mx-auto">
                    <header>
                        <h1>Nicolas Portmann</h1>
                        <div class="sub">
                            <span>Software Engineering</span>
                            <span>Security Engineering</span>
                            <span>Applied Cryptography</span>
                            <span>Performance Optimization</span>
                        </div>
                    </header>
                </div>
            </div>
        </a>
        <div class="content container mx-auto">
            <main>
                <header>
                    <h1>An io_uring based Transport Layer (Part I) - Rationale</h1>
                    
                    
    <section>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <span class="meta">2020/02/04</span>
        </span>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <span class="meta">Nicolas Portmann</span>
        </span>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0
                        014-4z"></path>
            </svg>
            <span class="meta">io_uring</span>
        </span>
    </section>

                </header>
                <article class="text">
                    <p>In this series, we are going to explore what it takes to develop an <code>io_uring</code>-based Transport layer for .NET. But before we are getting down to the nitty-gritty, we should think about whether this endeavor is a good idea to begin with.</p>
<p>If you are writing network code for a living or are otherwise familiar with the topic, by all means, skip this episode and check out <a href="https://ndportmann.com/io_uring-foundation/" title="io_uring Foundation - GitHub">the next one</a>.</p>
<h2>What is a Transport Layer?</h2>
<p>Let's start by answering the question of what a Transport layer is. David Fowler and friends (both inside and outside of Microsoft) developed the ASP.NET Connections Abstractions as part of a project codenamed &quot;Bedrock&quot;. If we talk about the Bedrock abstractions here, we talk about the classes and interfaces available as <a href="https://github.com/dotnet/aspnetcore/tree/master/src/Servers/Connections.Abstractions/src" title="Connections.Abstractions - AspNetCore - GitHub">Microsoft.AspNetCore.Connections.Abstractions</a>.</p>
<p>There are three core concepts to the architecture of Bedrock (<a href="https://speakerdeck.com/davidfowl/project-bedrock" title="Project Bedrock - David Fowler - Speakerdeck">source</a>) upon which most networked .NET applications are built:</p>
<ul>
<li>Transports</li>
<li>Middleware</li>
<li>Protocols</li>
</ul>
<p><strong>Transports</strong> are concerned with how we obtain connections and how bytes are transferred from/to those connections. <strong>Middleware</strong> handles cross-cutting concerns (e.g., sessions, authentication), a concept familiar to ASP.NET developers. <strong>Protocols</strong> handle the details of specific protocols to give the bytes received from a connection a meaning.</p>
<p>There are already a couple of Transport implementations (also called layers) out there. Most prominently, the <a href="https://github.com/dotnet/aspnetcore/tree/master/src/Servers/Kestrel/Transport.Sockets" title="Transport.Sockets - AspNetCore - GitHub">Sockets Transport</a> used in Kestrel by default. The Sockets Transport is based on the <code>Socket</code> type from the base class library (BCL). It is cleverly written and well optimized.</p>
<p>The community contributed another, Linux-specific Transport layer.  <a href="https://github.com/redhat-developer/kestrel-linux-transport/" title="kestrel-linux-transport - redhat-developer - GitHub">redhat-developer/kestrel-linux-transport</a> is tailored to the best in class Linux APIs for networking (<code>epoll</code>, <code>AIO</code>, and co.). See Tom Deseyns <a href="https://developers.redhat.com/blog/2018/07/24/improv-net-core-kestrel-performance-linux/" title="Improving .NET Core Kestrel performance using a Linux-specific transport - Red Hat">blog post introducing the project</a> for details.</p>
<h2>Why yet another Transport Layer?</h2>
<p>So why do we need yet another Transport layer? Well, there is a new kid on the block called <code>io_uring</code>. It promises to improve the I/O story for Linux and generally bring better performance to I/O heavy applications. Details on how this is achieved can be found in <a href="https://www.slideshare.net/ennael/kernel-recipes-2019-faster-io-through-iouring" title="Faster IO through io_uring - Jens Axboe - Slideshare">this slideshow</a>.</p>
<p>With a smart design and some fancy kernel-tricks, <code>io_uring</code> offers an API for writing high-performance network code without relying on &quot;dirty tricks&quot;. Userspace network drivers (e.g., DPDK) use stunts such as <em>kernel bypass</em> to achieve high performance at the cost of losing everything the kernel has to offer.</p>
<p>The current Transport layers were built in a time before the adoption of <code>io_uring</code> in an LTS kernel version. <code>io_uring</code> is still being developed with new features added in every recent kernel version. What better time than now to investigate the use of <code>io_uring</code> in .NET, when we can still contribute to its development via feedback to the kernel devs.</p>
<p>Writing a new Transport layer doesn't only benefit ASP.NET Core. Other frameworks and libraries, such as Orleans, are also jumping onto the Bedrock abstractions. A faster Transport, therefore, means improvements across many applications. And in times where you pay your cloud provider by the CPU cycle, performance matters not only for your users ðŸš€ but also for your wallet ðŸ’¸.</p>
<p>This series is, therefore, a documentation of the journey towards building yet another Transport layer for .NET networking applications based on the new io_uring API: To outperform the previously mentioned Sockets and Linux Transports on Linux kernels that support it.</p>
<h2>Why is <code>io_uring</code> significant?</h2>
<h3>The Cost of syscalls</h3>
<p>Ren et al. discovered in their 2019 paper <em><a href="https://dl.acm.org/doi/pdf/10.1145/3341301.3359640?download=true" title="Paper on syscall Performance - Ren et al.">An Analysis of Performance Evolution of Linuxâ€™s Core Operations</a></em> that the cost of syscalls such as <code>mmap</code>, <code>read</code>, <code>write</code> have gone up significantly in recent times. The 11 root causes responsible for the slowdown fall in one of three categories:</p>
<ul>
<li><strong>Security Enhancements</strong> that likely cause permanent slowdowns due to software mitigation for hardware (CPU) issues.</li>
<li><strong>New Features</strong> that add overhead or just haven't been properly optimized yet.</li>
<li><strong>Configuration Changes</strong>, which were discovered and - for the most part - fixed in recent kernel versions</li>
</ul>
<p>Surprisingly, the security enhancements are the least impactful of the above.</p>
<p>Writing a high-performance network or I/O stack offers many opportunities for optimizations. This is likely the reason why there are so many different network stacks. The go-to site to compare network stacks is <a href="https://www.techempower.com/benchmarks" title="TechEmpower Benchmarks">TechEmpower</a>, where well over 300 frameworks, runtimes, and configurations compete against each other.</p>
<p>The underlying optimization techniques are, however, the same for most I/O stacks and include but aren't limited to the following guidelines:</p>
<ul>
<li>Avoid syscalls</li>
<li>Never block (<code>O_NONBLOCK</code>)</li>
<li>Never copy (<code>SO_ZEROCOPY</code>)</li>
<li>Avoid interrupts (polled I/O)</li>
<li>Optimize thread affinity</li>
</ul>
<h3>Enter <code>io_uring</code></h3>
<p><code>io_uring</code> - the brainchild of <a href="https://twitter.com/axboe" title="Jens Axboe - Twitter">Jens Axboe</a> -  is the latest addition to the I/O interfaces of the Linux kernel. It improves the status quo regarding most of the above levers for performance. In theory and extreme cases, it even enables  I/O-operations without any syscalls at all. In more reasonable settings, it allows for a drastically reduced number of syscalls for a given application and to minimize the cost of I/O-operations using neat tricks such as <a href="https://patchwork.kernel.org/patch/10792947/" title="Kernel Patch 10792947">using pre-mapped I/O buffers</a>.</p>
<p>If you are used to the BCL, Linux I/O APIs are rarely easy to consume. This is especially true for more sophisticated interfaces such as <code>epoll</code>. The same holds for <code>io_uring</code>, which is probably why Jens Axboe started writing the <a href="https://github.com/axboe/liburing" title="luburing - axboe - GitHub"><code>liburing</code></a> library to make it somewhat easier to profit from <code>io_uring</code>.</p>
<p><code>liburing</code> offers convenience methods for each operation supported by <code>io_uring</code>. While being convenient, this would mean a lot of P/Invoked methods in the Transport layer should we decide to leverage <code>liburing</code>. With the license of <code>liburing</code> <a href="https://github.com/axboe/liburing/commit/b9f507d50c71b27f5c0239a28fa29db5ce2bf533" title="MIT Licence - liburing - axboe - GitHub">changed to MIT</a>, it was relatively easy to reverse engineer it and to write a similar but managed library: <a href="https://github.com/tkp1n/IoUring/#iouring" title="IoUring - GitHub">IoUring</a>.</p>
<p>IoUring builds the foundation upon which the IoUring.Transport is built - a foundation which we explore in detail, in <a href="https://ndportmann.com/io_uring-foundation/" title="io_uring Foundataion - ndportmann.com">the next episode</a> of this series.</p>
<h2>Summary</h2>
<p>A new set of I/O interfaces were added to the most recent LTS version of the Linux kernel. There is currently no way to profit from the new APIs from a .NET application. At the same time, the introduction of the Bedrock abstractions made it easier than ever to add a new Transport layer to networked .NET applications. The best time to experiment with an <code>io_uring</code> based Transport is now. <a href="https://github.com/tkp1n/IoUring" title="IoUring - GitHub">tkp1n/IoUring</a> is open for contributions!</p>

                </article>
            </main>
        </div>
        <footer>
            <p>&#169; Nicolas Portmann</p>
        </footer>
    </body>
</html>