<!DOCTYPE html><!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Logging with Context in Spring WebFlux (Part II)</title>
        <meta name="description" content="A Software Engineering Blog">
        <meta property="og:url" content="https://ndportmann.com/logging-with-context-in-spring-webflux/">
        <meta property="og:title" content="Logging with Context in Spring WebFlux (Part II)">
        <meta property="og:description" content="A blog about software engineering and applied cryptography.">
        <meta property="og:type" content="article">
        <meta name="twitter:site" content="@tkp1n">
        <meta name="twitter:creator" content="@tkp1n">
        <meta name="twitter:card" content="summary">
        <style>
            
            /*! tailwindcss v2.1.1 | MIT License | https://tailwindcss.com *//*! modern-normalize v1.0.0 | MIT License | https://github.com/sindresorhus/modern-normalize */*,::after,::before{box-sizing:border-box}:root{-moz-tab-size:4;tab-size:4}html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji'}hr{height:0;color:inherit}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset{margin:0;padding:0}ol,ul{list-style:none;margin:0;padding:0}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}body{font-family:inherit;line-height:inherit}*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}:root{--size-0_5:0.125rem;--size-1:0.250rem;--size-1_5:0.375rem;--size-2:0.5rem;--size-3:0.75rem;--size-3_5:0.875rem;--size-4:1rem;--size-4_5:1.125rem;--size-5:1.25rem;--size-6:1.5rem;--size-7:1.75rem;--size-7_5:1.875rem;--size-8:2rem;--size-9:2.25rem;--size-10:2.5rem;--size-xs:20rem;--size-md:28rem;--weight-extralight:200;--weight-light:300;--weight-bitbold:400;--weight-semibold:600;--blue-500:rgba(59, 130, 246, 1);--blue-600:rgba(37, 99, 235, 1);--blue-800:rgba(37, 99, 235, 1);--white:rgba(255, 255, 255, 1);--gray-200:rgba(229, 231, 235, 1);--gray-500:rgba(107, 114, 128, 1);--gray-800:rgba(31, 41, 55, 1);--black:rgba(0, 0, 0, 1)}*{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.max-w-screen-lg{max-width:1024px}.max-w-screen-md{max-width:768px}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}@media (min-width:1536px){.container{max-width:1536px}}.mx-auto{margin-left:auto;margin-right:auto}.shadow{--tw-shadow:0 1px 3px 0 rgba(0, 0, 0, 0.1),0 1px 2px 0 rgba(0, 0, 0, 0.06);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.rounded{border-radius:.25rem}h2{font-size:var(--size-5);line-height:var(--size-7);margin-left:var(--size-4);margin-top:var(--size-6)}@media (min-width:1024px){h2{font-size:var(--size-6);line-height:var(--size-8)}}h3{font-size:var(--size-4_5);line-height:var(--size-7);margin-top:var(--size-6);color:var(--gray-800);font-weight:var(--weight-semibold);letter-spacing:-.025em}@media (min-width:1024px){h3{font-size:var(--size-5);line-height:var(--size-7)}}h4{margin-top:var(--size-5);font-weight:var(--weight-semibold)}.icon{width:var(--size-5);height:var(--size-5);margin-bottom:var(--size-1);display:inline}.tag{padding-right:var(--size-3);white-space:nowrap}pre{border-radius:var(--size-1)}ul{list-style:disc;padding-left:var(--size-4_5)}ol{list-style:decimal;padding-left:var(--size-4_5)}blockquote{margin-top:1rem;padding-left:1rem;border-left:4px solid #dadada}th{text-align:start;font-weight:var(--weight-bitbold)}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:0 0;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.header h1{margin-top:0;font-size:var(--size-4_5);line-height:var(--size-7)}@media(min-width:1024px){.header h1{font-size:var(--size-5)}}.sub{font-size:var(--size-4);line-height:var(--size-6);font-weight:var(--weight-extralight);height:var(--size-6)}.sub span{animation:fade 10s linear infinite 0s;opacity:0;overflow:hidden;position:absolute}.sub span:nth-child(2){animation-delay:2.5s}.sub span:nth-child(3){animation-delay:5s}.sub span:nth-child(4){animation-delay:7.5s}@media(min-width:1024px){.sub{font-size:var(--size-4_5);line-height:var(--size-7)}}@keyframes fade{0%{opacity:0}5%{opacity:0}10%{opacity:1}25%{opacity:1}30%{opacity:0}100%{opacity:0}}.outer{margin-top:var(--size-8);background-color:var(--blue-600);transform:skewY(6deg);width:66.666667%;max-width:var(--size-xs);min-width:-webkit-min-content;min-width:min-content}@media(min-width:1024px){.outer{max-width:var(--size-md)}}.inner{padding:var(--size-2);background-color:var(--white);transform:skewY(-6deg);width:80%}header>h1{font-size:var(--size-6);line-height:var(--size-8);margin-top:var(--size-7)}@media(min-width:1024px){header>h1{font-size:var(--size-7);line-height:var(--size-9)}}h1,h2,h3,h4,h5,h6{margin-left:0}.content{max-width:768px;margin-top:var(--size-6);padding-right:var(--size-5);padding-left:var(--size-5)}.text{margin-top:var(--size-2);font-size:var(--size-4)}.text p{padding-top:var(--size-4)}.text a{color:var(--blue-600)}.text a:hover{text-decoration:underline}.text pre{margin-top:var(--size-1);margin-bottom:var(--size-1)}.text table{table-layout:auto;width:100%;margin-top:var(--size-2);margin-bottom:var(--size-2)}.text tr{border-bottom-width:1px}.text td{padding:var(--size-1_5)}:not(a)>code{border-radius:var(--size-1);padding:var(--size-0_5);background-color:var(--gray-200)}.text blockquote>p{padding-top:0}footer{padding-top:var(--size-4);padding-bottom:var(--size-2);width:100%;text-align:center}
        </style>
        <link rel="stylesheet" href="../prism-okaidia.min.css">
        <link rel="stylesheet" href="../katex.min.css">
    </head>
    <body>
        <a href="/" class="header">
            <div class="outer shadow rounded mx-auto">
                <div class="inner shadow rounded mx-auto">
                    <header>
                        <h1>Nicolas Portmann</h1>
                        <div class="sub">
                            <span>Software Engineering</span>
                            <span>Security Engineering</span>
                            <span>Applied Cryptography</span>
                            <span>Performance Optimization</span>
                        </div>
                    </header>
                </div>
            </div>
        </a>
        <div class="content container mx-auto">
            <main>
                <header>
                    <h1>Logging with Context in Spring WebFlux (Part II)</h1>
                    
                    
    <section>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <span class="meta">2019/01/05</span>
        </span>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <span class="meta">Nicolas Portmann</span>
        </span>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0
                        014-4z"></path>
            </svg>
            <span class="meta">Java</span>
        </span>
    </section>

                </header>
                <article class="text">
                    <p>In the first part, we investigated how context information such as MDCs can be passed from and to a Spring WebFlux application. We shall now investigate how we can enrich said context and include it in our log messages.</p>
<h2>Adding to the Context</h2>
<p>To add context information to the <code>Context</code>, we use the method <code>subscriberContext</code> present on all <code>Mono</code> and <code>Flux</code> instances. It accepts a <code>Function&lt;Context, Context&gt;</code> which transforms the exisiting immutable <code>Context</code> into a new <code>Context</code>. In this case with an additional information.</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">processRequestForClient</span><span class="token punctuation">(</span><span class="token class-name">String</span> clientId<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>id <span class="token operator">-></span> <span class="token function">processRequest</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><br>            <span class="token punctuation">.</span><span class="token function">subscriberContext</span><span class="token punctuation">(</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"CLIENT-ID"</span><span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>The helper function <code>put</code> below provides the required <code>Function&lt;Context, Context&gt;</code> that adds the given key and value to the context or creates a new context if none exists.</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> CONTEXT_MAP <span class="token operator">=</span> <span class="token string">"context-map"</span><span class="token punctuation">;</span><br><br><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Context</span><span class="token punctuation">,</span> <span class="token class-name">Context</span><span class="token punctuation">></span></span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> ctx <span class="token operator">-></span> <span class="token punctuation">{</span><br>        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> maybeContextMap <span class="token operator">=</span><br>                ctx<span class="token punctuation">.</span><span class="token function">getOrEmpty</span><span class="token punctuation">(</span>CONTEXT_MAP<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span>maybeContextMap<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>            maybeContextMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token keyword">return</span> ctx<span class="token punctuation">;</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> ctxMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            ctxMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>            <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>CONTEXT_MAP<span class="token punctuation">,</span> ctxMap<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>Above usage of <code>subscriberContext</code> seems odd, as the addition to the context appears to be the last operation in the chain of calls. The <a href="https://projectreactor.io/docs/core/release/reference/#_simple_context_examples" title="Simple Context Examples - Reactor documentation">Reactor documentation</a> sheds some light on this oddity:</p>
<blockquote>
<p>Even though subscriberContext is the last piece of the chain, it is the one that gets executed first (due to its subscription time nature, and the fact that the subscription signal flows from bottom to top).</p>
</blockquote>
<h2>Logging with context</h2>
<p>Time for the final piece of the puzzle; writing logs with set context applied. Just as with the <a href="https://simonbasle.github.io/2018/02/contextual-logging-with-reactor-context-and-mdc/" title="Contextual Logging with Reactor Context and MDC - Simon Basle">approach suggested by Simon Basle</a> (mentioned in the previous post), we utilize <code>doOnEach</code> with two helper methods to log with context. The helper methods, in this case, are <code>logOnNext</code> and <code>logOnError</code>. Both invoke a lambda that accepts the current result or the exception respectively. We could therefore add the following two log statemets to the <code>processRequestForClient</code> method from above.</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@Service</span><br><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FooService</span> <span class="token punctuation">{</span><br>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <br>        <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">FooService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">processRequestForClient</span><span class="token punctuation">(</span><span class="token class-name">String</span> clientId<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>id <span class="token operator">-></span> <span class="token function">processRequest</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><br>                <span class="token punctuation">.</span><span class="token function">doOnEach</span><span class="token punctuation">(</span><span class="token function">logOnNext</span><span class="token punctuation">(</span><br>                        res <span class="token operator">-></span> logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Result: {}"</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">)</span><br>                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doOnEach</span><span class="token punctuation">(</span><span class="token function">logOnError</span><span class="token punctuation">(</span><br>                        e <span class="token operator">-></span> logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"An error occurred..."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span><br>                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscriberContext</span><span class="token punctuation">(</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"CLIENT-ID"</span><span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<p>The helper methods <code>logOnNext</code> and <code>logOnError</code> are best placed in a helper class. Both extract the context information from the <code>doOnEach</code> <code>Signal</code> and put set it as the MDC before calling the provided lambda.</p>
<pre class="language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">LogHelper</span> <span class="token punctuation">{</span><br>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Signal</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">logOnNext</span><span class="token punctuation">(</span><br>            <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> log<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> signal <span class="token operator">-></span> <span class="token punctuation">{</span><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span>signal<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">SignalType</span><span class="token punctuation">.</span>ON_NEXT<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>            <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> maybeContextMap<br>                    <span class="token operator">=</span> signal<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrEmpty</span><span class="token punctuation">(</span>CONTEXT_MAP<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span>maybeContextMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                log<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>signal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                MDC<span class="token punctuation">.</span><span class="token function">setContextMap</span><span class="token punctuation">(</span>maybeContextMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token keyword">try</span> <span class="token punctuation">{</span><br>                    log<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>signal<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span><br>                    MDC<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Signal</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">logOnError</span><span class="token punctuation">(</span><br>            <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Throwable</span><span class="token punctuation">></span></span> log<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">return</span> signal <span class="token operator">-></span> <span class="token punctuation">{</span><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>signal<span class="token punctuation">.</span><span class="token function">isOnError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span><br><br>            <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> maybeContextMap<br>                    <span class="token operator">=</span> signal<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrEmpty</span><span class="token punctuation">(</span>CONTEXT_MAP<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>            <span class="token keyword">if</span> <span class="token punctuation">(</span>maybeContextMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>                log<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>signal<span class="token punctuation">.</span><span class="token function">getThrowable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>                MDC<span class="token punctuation">.</span><span class="token function">setContextMap</span><span class="token punctuation">(</span>maybeContextMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token keyword">try</span> <span class="token punctuation">{</span><br>                    log<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>signal<span class="token punctuation">.</span><span class="token function">getThrowable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span><br>                    MDC<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>                <span class="token punctuation">}</span><br>            <span class="token punctuation">}</span><br>        <span class="token punctuation">}</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h2>Summary</h2>
<p>If we extend our <code>DemoController</code> from part one with a call to above <code>FooService</code>, we are now able to perform the following request:</p>
<pre class="language-java"><code class="language-java"><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/demo/{clientId}"</span><span class="token punctuation">)</span><br><span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">clientDemo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> clientId<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> fooService<span class="token punctuation">.</span><span class="token function">processRequestForClient</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<pre class="language-bash"><code class="language-bash">$ <span class="token function">curl</span> -v -X POST -H <span class="token string">"X-MDC-FOO: BAR"</span> localhost:8080/demo/123<br><span class="token operator">></span> POST /demo/123 HTTP/1.1<br><span class="token operator">></span> Host: localhost:8080<br><span class="token operator">></span> User-Agent: curl/7.58.0<br><span class="token operator">></span> Accept: */*<br><span class="token operator">></span> X-MDC-FOO: BAR<br><span class="token operator">></span><br><span class="token operator">&lt;</span> HTTP/1.1 <span class="token number">200</span> OK<br><span class="token operator">&lt;</span> Content-Type: text/plain<span class="token punctuation">;</span><span class="token assign-left variable">charset</span><span class="token operator">=</span>UTF-8<br><span class="token operator">&lt;</span> Content-Length: <span class="token number">2</span><br><span class="token operator">&lt;</span> X-MDC-CLIENT-ID: <span class="token number">123</span><br><span class="token operator">&lt;</span> X-MDC-FOO: BAR<br><span class="token operator">&lt;</span><br><span class="token number">42</span></code></pre>
<p>The log record for the request reads as follows:<br>
<code>2019-01-04 ... FooService: Result: 42 CLIENT-ID=123, FOO=BAR</code></p>
<p>We have therefore successfully added information to the context, which ended up both in the response headers and in the log message, together with the context from the callee.</p>
<blockquote>
<p>The entire project is on <a href="https://github.com/tkp1n/mdc-webflux" title="MDC-WebFlux project on GitHub">github</a> for your reference.</p>
</blockquote>

                </article>
            </main>
        </div>
        <footer>
            <p>&#169; Nicolas Portmann</p>
        </footer>
    </body>
</html>