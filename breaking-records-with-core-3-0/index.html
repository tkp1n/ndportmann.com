<!DOCTYPE html><!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Breaking all existing Hex Encoding Records with .NET Core 3.0</title>
        <meta name="description" content="A Software Engineering Blog">
        <meta property="og:url" content="https://ndportmann.com/breaking-records-with-core-3-0/">
        <meta property="og:title" content="Breaking all existing Hex Encoding Records with .NET Core 3.0">
        <meta property="og:description" content="A blog about software engineering and applied cryptography.">
        <meta property="og:type" content="article">
        <meta name="twitter:site" content="@tkp1n">
        <meta name="twitter:creator" content="@tkp1n">
        <meta name="twitter:card" content="summary">
        <style>
            
            /*! tailwindcss v2.1.1 | MIT License | https://tailwindcss.com *//*! modern-normalize v1.0.0 | MIT License | https://github.com/sindresorhus/modern-normalize */*,::after,::before{box-sizing:border-box}:root{-moz-tab-size:4;tab-size:4}html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji'}hr{height:0;color:inherit}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset{margin:0;padding:0}ol,ul{list-style:none;margin:0;padding:0}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}body{font-family:inherit;line-height:inherit}*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}:root{--size-0_5:0.125rem;--size-1:0.250rem;--size-1_5:0.375rem;--size-2:0.5rem;--size-3:0.75rem;--size-3_5:0.875rem;--size-4:1rem;--size-4_5:1.125rem;--size-5:1.25rem;--size-6:1.5rem;--size-7:1.75rem;--size-7_5:1.875rem;--size-8:2rem;--size-9:2.25rem;--size-10:2.5rem;--size-xs:20rem;--size-md:28rem;--weight-extralight:200;--weight-light:300;--weight-bitbold:400;--weight-semibold:600;--blue-500:rgba(59, 130, 246, 1);--blue-600:rgba(37, 99, 235, 1);--blue-800:rgba(37, 99, 235, 1);--white:rgba(255, 255, 255, 1);--gray-200:rgba(229, 231, 235, 1);--gray-500:rgba(107, 114, 128, 1);--gray-800:rgba(31, 41, 55, 1);--black:rgba(0, 0, 0, 1)}*{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.max-w-screen-lg{max-width:1024px}.max-w-screen-md{max-width:768px}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}@media (min-width:1536px){.container{max-width:1536px}}.mx-auto{margin-left:auto;margin-right:auto}.shadow{--tw-shadow:0 1px 3px 0 rgba(0, 0, 0, 0.1),0 1px 2px 0 rgba(0, 0, 0, 0.06);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.rounded{border-radius:.25rem}h2{font-size:var(--size-5);line-height:var(--size-7);margin-left:var(--size-4);margin-top:var(--size-6)}@media (min-width:1024px){h2{font-size:var(--size-6);line-height:var(--size-8)}}h3{font-size:var(--size-4_5);line-height:var(--size-7);margin-top:var(--size-6);color:var(--gray-800);font-weight:var(--weight-semibold);letter-spacing:-.025em}@media (min-width:1024px){h3{font-size:var(--size-5);line-height:var(--size-7)}}h4{margin-top:var(--size-5);font-weight:var(--weight-semibold)}.icon{width:var(--size-5);height:var(--size-5);margin-bottom:var(--size-1);display:inline}.tag{padding-right:var(--size-3);white-space:nowrap}pre{border-radius:var(--size-1)}ul{list-style:disc;padding-left:var(--size-4_5)}ol{list-style:decimal;padding-left:var(--size-4_5)}blockquote{margin-top:1rem;padding-left:1rem;border-left:4px solid #dadada}th{text-align:start;font-weight:var(--weight-bitbold)}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:0 0;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.header h1{margin-top:0;font-size:var(--size-4_5);line-height:var(--size-7)}@media(min-width:1024px){.header h1{font-size:var(--size-5)}}.sub{font-size:var(--size-4);line-height:var(--size-6);font-weight:var(--weight-extralight);height:var(--size-6)}.sub span{animation:fade 10s linear infinite 0s;opacity:0;overflow:hidden;position:absolute}.sub span:nth-child(2){animation-delay:2.5s}.sub span:nth-child(3){animation-delay:5s}.sub span:nth-child(4){animation-delay:7.5s}@media(min-width:1024px){.sub{font-size:var(--size-4_5);line-height:var(--size-7)}}@keyframes fade{0%{opacity:0}5%{opacity:0}10%{opacity:1}25%{opacity:1}30%{opacity:0}100%{opacity:0}}.outer{margin-top:var(--size-8);background-color:var(--blue-600);transform:skewY(6deg);width:66.666667%;max-width:var(--size-xs);min-width:-webkit-min-content;min-width:min-content}@media(min-width:1024px){.outer{max-width:var(--size-md)}}.inner{padding:var(--size-2);background-color:var(--white);transform:skewY(-6deg);width:80%}header>h1{font-size:var(--size-6);line-height:var(--size-8);margin-top:var(--size-7)}@media(min-width:1024px){header>h1{font-size:var(--size-7);line-height:var(--size-9)}}h1,h2,h3,h4,h5,h6{margin-left:0}.content{max-width:768px;margin-top:var(--size-6);padding-right:var(--size-5);padding-left:var(--size-5)}.text{margin-top:var(--size-2);font-size:var(--size-4)}.text p{padding-top:var(--size-4)}.text a{color:var(--blue-600)}.text a:hover{text-decoration:underline}.text pre{margin-top:var(--size-1);margin-bottom:var(--size-1)}.text table{table-layout:auto;width:100%;margin-top:var(--size-2);margin-bottom:var(--size-2)}.text tr{border-bottom-width:1px}.text td{padding:var(--size-1_5)}:not(a)>code{border-radius:var(--size-1);padding:var(--size-0_5);background-color:var(--gray-200)}.text blockquote>p{padding-top:0}footer{padding-top:var(--size-4);padding-bottom:var(--size-2);width:100%;text-align:center}
        </style>
        <link rel="stylesheet" href="../prism-okaidia.min.css">
        <link rel="stylesheet" href="../katex.min.css">
    </head>
    <body>
        <a href="/" class="header">
            <div class="outer shadow rounded mx-auto">
                <div class="inner shadow rounded mx-auto">
                    <header>
                        <h1>Nicolas Portmann</h1>
                        <div class="sub">
                            <span>Software Engineering</span>
                            <span>Security Engineering</span>
                            <span>Applied Cryptography</span>
                            <span>Performance Optimization</span>
                        </div>
                    </header>
                </div>
            </div>
        </a>
        <div class="content container mx-auto">
            <main>
                <header>
                    <h1>Breaking all existing Hex Encoding Records with .NET Core 3.0</h1>
                    
                    
    <section>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <span class="meta">2019/07/26</span>
        </span>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <span class="meta">Nicolas Portmann</span>
        </span>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0
                        014-4z"></path>
            </svg>
            <span class="meta">.NET</span>
        </span>
    </section>

                </header>
                <article class="text">
                    <p>It all started over 10 years ago when someone dared to ask &quot;<a href="https://stackoverflow.com/questions/311165/how-do-you-convert-a-byte-array-to-a-hexadecimal-string-and-vice-versa?answertab=oldest#tab-top" title="Question on StackOverflow">how to convert a byte array to a hexadecimal string?</a>&quot; over at Stack Overflow. The community quickly provided several very different answers. Some involved loops, some LINQ, others bent the available Framework-methods to their needs. Both bit fiddlers and lookup table magicians entered the field and presented their more and more unsafe solutions. <a href="https://github.com/patridge" title="patridge - GitHub">Adam Patridge</a> stepped in quite a bit later and benchmarked all submitted solutions.</p>
<p>Today - more than 10 years later - we are going to beat all previous records once again, utilizing the new secret sauce introduced in .NET Core 3.0: hardware intrinsics. But let's have a look at the current champion of hex encoding fist.</p>
<h2>The Current Champion</h2>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">static</span> <span class="token class-name"><span class="token keyword">uint</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> _Lookup32 <span class="token operator">=</span> Enumerable<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>i <span class="token operator">=></span> <br><span class="token punctuation">{</span><br>    <span class="token class-name"><span class="token keyword">string</span></span> s <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">"X2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span><span class="token punctuation">(</span>BitConverter<span class="token punctuation">.</span>IsLittleEndian<span class="token punctuation">)</span><br>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint</span><span class="token punctuation">)</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint</span><span class="token punctuation">)</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">else</span><br>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint</span><span class="token punctuation">)</span>s<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint</span><span class="token punctuation">)</span>s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token keyword">uint</span><span class="token operator">*</span> _lookup32UnsafeP <span class="token operator">=</span><br>    <span class="token punctuation">(</span><span class="token keyword">uint</span><span class="token operator">*</span><span class="token punctuation">)</span>GCHandle<span class="token punctuation">.</span><span class="token function">Alloc</span><span class="token punctuation">(</span>_Lookup32<span class="token punctuation">,</span> GCHandleType<span class="token punctuation">.</span>Pinned<span class="token punctuation">)</span><br>    <span class="token punctuation">.</span><span class="token function">AddrOfPinnedObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> <span class="token function">ByteArrayToHexViaLookup32UnsafeDirect</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> bytes<span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> lookupP <span class="token operator">=</span> _lookup32UnsafeP<span class="token punctuation">;</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">string</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> bytes<span class="token punctuation">.</span>Length <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">fixed</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token operator">*</span> bytesP <span class="token operator">=</span> bytes<span class="token punctuation">)</span><br>    <span class="token keyword">fixed</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> resultP <span class="token operator">=</span> result<span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token keyword">uint</span><span class="token operator">*</span> resultP2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint</span><span class="token operator">*</span><span class="token punctuation">)</span>resultP<span class="token punctuation">;</span><br>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bytes<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><br>            resultP2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> lookupP<span class="token punctuation">[</span>bytesP<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">return</span> result<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p>The process of encoding a <code>byte</code> into its hex representation converts one byte into two characters. Each character is a 16-bit value (<code>char</code>). The two characters representing a given byte, therefore, take up exactly 32-bits, the size of a <code>uint</code>. The first lines above create a lookup table for every one of the 256 possible <code>byte</code> values. The resulting table is exactly 1 KB in size and pinned in memory by the second group of lines to get a <code>uint*</code> (I'm sure you've noticed by now, that the entire snippet is <code>unsafe</code> C#). We'll talk more about this trick later, as there are downsides to consider at least until the <a href="https://github.com/dotnet/coreclr/blob/master/Documentation/design-docs/PinnedHeap.md" title="PinnedHeap.md - CoreCLR Documentation">Pinned Heap</a> GC-feature is ready.</p>
<p>The main method creates a right-sized string, takes its address using the <code>fixed</code> keyword and turns every input byte in its respective two-character hex representation using the pinned lookup table described above.</p>
<p>If you crave performance, this method does a couple of things very well:</p>
<ul>
<li>The one-time calculation of a lookup table is a typical memory vs. speed trade-off (investing 1 KB of memory for a significant speed-up can be a good thing).</li>
<li>Permanently pinning the lookup table <em>potentially</em> reduces the method overhead, as it does not have to fix the lookup table on each invocation.</li>
<li>Turing <code>_lookup32UnsafeP</code> into a local variable <code>lookupP</code> means the lookup of the static variable happens only once (instead of in the loop).</li>
<li>Creating a right sized-string and working with it's pinned address avoids unnecessary copies. There even is a <a href="https://github.com/dotnet/coreclr/blob/5937becd8823312d6b2d490a4d977ec663def72d/src/System.Private.CoreLib/shared/System/String.cs#L280" title="String.cs - CoreCLR - GitHub">fast-path</a> for the chosen constructor if the first parameter is the zero/null <code>char</code>.</li>
</ul>
<p>There are, however, downsides or potential improvements to almost all of the above optimizations:</p>
<ul>
<li>The lookup table is too large to reside in the cache closest to the processing units completely. This results in data-dependent execution times due to cache-misses.</li>
<li>Keeping the lookup table pinned permanently causes trouble for the GC, as it will never be able to relocate the array and must work its way around it. An alternative would be to unpin the array in a <code>Dispose</code> method, or just pinning the array inside of the actual method.</li>
<li>The <code>string.Create</code> method introduced in .NET Core 2.1 is even cleaner (more obvious) than the cleverly used string constructor.</li>
</ul>
<h2>Benchmarking is Hard - Use BenchmarkDotNet</h2>
<p>The original benchmarks are still on <a href="https://github.com/patridge/PerformanceStubs" title="PerformanceStubs - patridge - GitHub">GitHub</a>. It is worth noting, however that they were written in a time before <a href="https://benchmarkdotnet.org/" title="BenchmarkDotNet.org">BenchmarkDotNet</a>. The .NET community today generally agrees to leave the setup and execution of benchmarks to BenchmarkDotnet instead of rolling your own. Luckily, the existing benchmark is easily portable to a BenchmarkDotNet project (as showcased over <a href="https://github.com/tkp1n/HexMate/blob/blog/HexMate.Benchmarks/BlogBench.cs" title="BlogBench.cs - HexMate - GitHub">here</a>).</p>
<p>The old benchmark used two text files as input for the various tested encoding algorithms. This is desirable to ensure consistent results. Unfortunately, the text files translate only to a subset of possible bytes as input to the algorithms (printable ASCII) which may favor branchy or lookup-based approaches. This is also easily improved by using <code>new Random(42).NextBytes(data)</code> as input. The constant seed ensures consistency, while <code>Random</code> pseudo-randomly produces all possible byte values.</p>
<p>Another potential issue with using files as input is their fixed size (in this case ,3.38 KB and 1.16 MB). BenchmarkDotnet allows for straightforward configuration of various input sizes <a href="https://github.com/tkp1n/HexMate/blob/b7f7e89252d2cc8a03f65e32566fcb4ce4963ee5/HexMate.Benchmarks/BlogBench.cs#L16" title="BlogBench.cs - HexMate - GitHub">like so</a>. For a general-purpose algorithm such as hex encoding, I typically prefer to test on three sizes of input data:</p>
<ul>
<li>The first one small enough to almost exclusively test the overhead of the methods under test</li>
<li>The second one small enough to ensure, input and output data can reside in a cache close to the processing units. This way, we make sure not to test memory bandwidth but the actual algorithm.</li>
<li>The third one large enough to make sure any unexpected algorithmic complexity would show up in the results.</li>
</ul>
<p>Below diagram shows the results of testing the current champion vs. my implementation <a href="https://github.com/tkp1n/HexMate" title="HexMate - GitHub">HexMate</a> for a lot of different input sizes. Please note that the scales are not linear (logarithmic), which lets the differences appear smaller than they are. The chart does, however, showcase the three categories of input data sizes quite well. Below 64 bytes we are only comparing the overhead of the methods. Unsurprisingly comparing a raw conversion method vs. a library-like implementation (HexMate) with a bunch of input validation favors the raw method. In the second category, we see HexMate taking off 🚀 and completing the job <strong>twice as fast</strong> (-65.31% @ 32 KiB) as its competitor. All measurements above the size of the L2 cache of my MacBook seem to be bottlenecked by memory speed. This means that the algorithm for converting (in my case) more than 512 KiB of data does not matter, as long as it is faster than the reads/stores from/to memory.</p>
<p><img src="HexMate.png" alt="HexMate vs ByteArrayToHexViaLookup32UnsafeDirect"></p>
<h2>The Hardware Intrinsics Magic</h2>
<p>Now that we studied the current Champion and discussed the benchmarking methodology it's time to look at HexMate. I started writing HexMate as a playground to explore the new hardware intrinsics API and as an implementation of my <a href="https://github.com/dotnet/corefx/issues/10013#issuecomment-511112311" title="Hex API Proposal - CoreFX - GitHub">API proposal</a> for .NET Core. It is apparent that hex encoding/decoding algorithms will likely always be <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>, so how do we improve upon the current Champion encoding a byte to two characters using two lookups? We work on multiple bytes at once using SIMD (single instruction, multiple data) instructions! The SSE instructions allow us to work on 16 bytes at a time, while AVX even works on 32-byte vectors. The following snippet is the main part of the inner loop of HexMates UTF-8 hex encoding algorithm using SSSE3 (full source <a href="https://github.com/tkp1n/HexMate/blob/master/HexMate/Formatter/Utf8/Utf8HexFormatter.Ssse3.cs" title="Utf8HexFormatter.Ssse3.cs - HexMate - GitHub">here</a>).</p>
<p>The first three lines isolate the high (<code>hiHalf</code>) and the low (<code>loHalf</code>) nibbles of each byte in the given <code>input</code> vector. Using <code>UnpackHigh</code> and <code>UnpackLow</code> (<code>punpckhbw</code> and <code>punpcklbw</code>), the isolated nibbles are arranged (interleaved) in the proper order. The <code>Shuffle</code> instruction (<code>pshufb</code>) performs a 16-byte lookup to translate the input nibbles into the desired UTF-8 codepoints (0x0A -&gt; 0x41, 0x06 -&gt; 0x36).</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token class-name"><span class="token keyword">var</span></span> hiShift <span class="token operator">=</span> <span class="token function">ShiftRightLogical</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">AsInt16</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AsByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token class-name"><span class="token keyword">var</span></span> hiHalf <span class="token operator">=</span> <span class="token function">And</span><span class="token punctuation">(</span>hiShift<span class="token punctuation">,</span> x0F<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token class-name"><span class="token keyword">var</span></span> loHalf <span class="token operator">=</span> <span class="token function">And</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> x0F<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token class-name"><span class="token keyword">var</span></span> hi <span class="token operator">=</span> <span class="token function">UnpackHigh</span><span class="token punctuation">(</span>hiHalf<span class="token punctuation">,</span> loHalf<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token class-name"><span class="token keyword">var</span></span> lo <span class="token operator">=</span> <span class="token function">UnpackLow</span><span class="token punctuation">(</span>hiHalf<span class="token punctuation">,</span> loHalf<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token class-name"><span class="token keyword">var</span></span> resLeft <span class="token operator">=</span> <span class="token function">Shuffle</span><span class="token punctuation">(</span>hexLookupTable<span class="token punctuation">,</span> hi<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token class-name"><span class="token keyword">var</span></span> resRight <span class="token operator">=</span> <span class="token function">Shuffle</span><span class="token punctuation">(</span>hexLookupTable<span class="token punctuation">,</span> lo<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>HexMate supports UTF-8 and UTF-16 encoding and validating decoding (both upper- and lowercase) using the following instruction sets to enable maximum performance on all modern (non-ARM, non-exotic) CPUs:</p>
<table>
<thead>
<tr>
<th></th>
<th style="text-align:center"><strong>SSE2</strong></th>
<th style="text-align:center"><strong>SSE41</strong></th>
<th style="text-align:center"><strong>SSSE3</strong></th>
<th style="text-align:center"><strong>AVX2</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Encoding</strong></td>
<td style="text-align:center">✅</td>
<td style="text-align:center">❌</td>
<td style="text-align:center">✅</td>
<td style="text-align:center">✅</td>
</tr>
<tr>
<td><strong>Decoding</strong></td>
<td style="text-align:center">✅</td>
<td style="text-align:center">✅</td>
<td style="text-align:center">✅</td>
<td style="text-align:center">✅</td>
</tr>
</tbody>
</table>
<p>Make sure to check out its source code on <a href="https://github.com/tkp1n/HexMate" title="HexMate - GitHub">GitHub</a> as well as the available <a href="https://www.nuget.org/packages/HexMate/" title="HexMate - NuGet">NuGet Package</a>. But most importantly; leave a vote or comment on <a href="https://github.com/dotnet/corefx/issues/10013" title="Issue #10013 - CoreFX - GitHub">corefx Issue 10013</a> to finally make hex encoding/decoding a part of the .NET framework.</p>

                </article>
            </main>
        </div>
        <footer>
            <p>&#169; Nicolas Portmann</p>
        </footer>
    </body>
</html>