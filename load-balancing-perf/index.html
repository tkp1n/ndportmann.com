<!DOCTYPE html><!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Randomized Round Robin (Load Balancing) as Fast as Possible</title>
        <meta name="description" content="A Software Engineering Blog">
        <meta property="og:url" content="https://ndportmann.com/load-balancing-perf/">
        <meta property="og:title" content="Randomized Round Robin (Load Balancing) as Fast as Possible">
        <meta property="og:description" content="A blog about software engineering and applied cryptography.">
        <meta property="og:type" content="article">
        <meta name="twitter:site" content="@tkp1n">
        <meta name="twitter:creator" content="@tkp1n">
        <meta name="twitter:card" content="summary">
        <style>
            
            /*! tailwindcss v2.1.1 | MIT License | https://tailwindcss.com *//*! modern-normalize v1.0.0 | MIT License | https://github.com/sindresorhus/modern-normalize */*,::after,::before{box-sizing:border-box}:root{-moz-tab-size:4;tab-size:4}html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji'}hr{height:0;color:inherit}abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset{margin:0;padding:0}ol,ul{list-style:none;margin:0;padding:0}html{font-family:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";line-height:1.5}body{font-family:inherit;line-height:inherit}*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}:root{--size-0_5:0.125rem;--size-1:0.250rem;--size-1_5:0.375rem;--size-2:0.5rem;--size-3:0.75rem;--size-3_5:0.875rem;--size-4:1rem;--size-4_5:1.125rem;--size-5:1.25rem;--size-6:1.5rem;--size-7:1.75rem;--size-7_5:1.875rem;--size-8:2rem;--size-9:2.25rem;--size-10:2.5rem;--size-xs:20rem;--size-md:28rem;--weight-extralight:200;--weight-light:300;--weight-bitbold:400;--weight-semibold:600;--blue-500:rgba(59, 130, 246, 1);--blue-600:rgba(37, 99, 235, 1);--blue-800:rgba(37, 99, 235, 1);--white:rgba(255, 255, 255, 1);--gray-200:rgba(229, 231, 235, 1);--gray-500:rgba(107, 114, 128, 1);--gray-800:rgba(31, 41, 55, 1);--black:rgba(0, 0, 0, 1)}*{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.max-w-screen-lg{max-width:1024px}.max-w-screen-md{max-width:768px}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}@media (min-width:1536px){.container{max-width:1536px}}.mx-auto{margin-left:auto;margin-right:auto}.shadow{--tw-shadow:0 1px 3px 0 rgba(0, 0, 0, 0.1),0 1px 2px 0 rgba(0, 0, 0, 0.06);box-shadow:var(--tw-ring-offset-shadow,0 0 #0000),var(--tw-ring-shadow,0 0 #0000),var(--tw-shadow)}.rounded{border-radius:.25rem}h2{font-size:var(--size-5);line-height:var(--size-7);margin-left:var(--size-4);margin-top:var(--size-6)}@media (min-width:1024px){h2{font-size:var(--size-6);line-height:var(--size-8)}}h3{font-size:var(--size-4_5);line-height:var(--size-7);margin-top:var(--size-6);color:var(--gray-800);font-weight:var(--weight-semibold);letter-spacing:-.025em}@media (min-width:1024px){h3{font-size:var(--size-5);line-height:var(--size-7)}}h4{margin-top:var(--size-5);font-weight:var(--weight-semibold)}.icon{width:var(--size-5);height:var(--size-5);margin-bottom:var(--size-1);display:inline}.tag{padding-right:var(--size-3);white-space:nowrap}pre{border-radius:var(--size-1)}ul{list-style:disc;padding-left:var(--size-4_5)}ol{list-style:decimal;padding-left:var(--size-4_5)}blockquote{margin-top:1rem;padding-left:1rem;border-left:4px solid #dadada}th{text-align:start;font-weight:var(--weight-bitbold)}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:0 0;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#8292a2}.token.punctuation{color:#f8f8f2}.token.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.header h1{margin-top:0;font-size:var(--size-4_5);line-height:var(--size-7)}@media(min-width:1024px){.header h1{font-size:var(--size-5)}}.sub{font-size:var(--size-4);line-height:var(--size-6);font-weight:var(--weight-extralight);height:var(--size-6)}.sub span{animation:fade 10s linear infinite 0s;opacity:0;overflow:hidden;position:absolute}.sub span:nth-child(2){animation-delay:2.5s}.sub span:nth-child(3){animation-delay:5s}.sub span:nth-child(4){animation-delay:7.5s}@media(min-width:1024px){.sub{font-size:var(--size-4_5);line-height:var(--size-7)}}@keyframes fade{0%{opacity:0}5%{opacity:0}10%{opacity:1}25%{opacity:1}30%{opacity:0}100%{opacity:0}}.outer{margin-top:var(--size-8);background-color:var(--blue-600);transform:skewY(6deg);width:66.666667%;max-width:var(--size-xs);min-width:-webkit-min-content;min-width:min-content}@media(min-width:1024px){.outer{max-width:var(--size-md)}}.inner{padding:var(--size-2);background-color:var(--white);transform:skewY(-6deg);width:80%}header>h1{font-size:var(--size-6);line-height:var(--size-8);margin-top:var(--size-7)}@media(min-width:1024px){header>h1{font-size:var(--size-7);line-height:var(--size-9)}}h1,h2,h3,h4,h5,h6{margin-left:0}.content{max-width:768px;margin-top:var(--size-6);padding-right:var(--size-5);padding-left:var(--size-5)}.text{margin-top:var(--size-2);font-size:var(--size-4)}.text p{padding-top:var(--size-4)}.text a{color:var(--blue-600)}.text a:hover{text-decoration:underline}.text pre{margin-top:var(--size-1);margin-bottom:var(--size-1)}.text table{table-layout:auto;width:100%;margin-top:var(--size-2);margin-bottom:var(--size-2)}.text tr{border-bottom-width:1px}.text td{padding:var(--size-1_5)}:not(a)>code{border-radius:var(--size-1);padding:var(--size-0_5);background-color:var(--gray-200)}.text blockquote>p{padding-top:0}footer{padding-top:var(--size-4);padding-bottom:var(--size-2);width:100%;text-align:center}
        </style>
        <link rel="stylesheet" href="../prism-okaidia.min.css">
        <link rel="stylesheet" href="../katex.min.css">
    </head>
    <body>
        <a href="/" class="header">
            <div class="outer shadow rounded mx-auto">
                <div class="inner shadow rounded mx-auto">
                    <header>
                        <h1>Nicolas Portmann</h1>
                        <div class="sub">
                            <span>Software Engineering</span>
                            <span>Security Engineering</span>
                            <span>Applied Cryptography</span>
                            <span>Performance Optimization</span>
                        </div>
                    </header>
                </div>
            </div>
        </a>
        <div class="content container mx-auto">
            <main>
                <header>
                    <h1>Randomized Round Robin (Load Balancing) as Fast as Possible</h1>
                    
                    
    <section>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <span class="meta">2019/10/17</span>
        </span>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <span class="meta">Nicolas Portmann</span>
        </span>
        <span class="tag">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="icon">
                <path 
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0
                        014-4z"></path>
            </svg>
            <span class="meta">.NET</span>
        </span>
    </section>

                </header>
                <article class="text">
                    <p>Another episode on gaining performance improvements by doing the as little as possible on the hot-path.</p>
<p><strong><code>Tl;dr</code></strong> Do all heavy-lifting upfront or in the background.</p>
<p>Load balancing is the act of distributing a given load across a set of resources. In this case, we are looking at ways to distribute requests over a set of connections to nodes performing the actual work.</p>
<p>The design constraints are as follows:</p>
<ul>
<li>Requests may arrive concurrently. The load balancer must, therefore, be thread-safe.</li>
<li>Requests may come in repeating patterns that should be broken up by the load balancer (e.g., by introducing randomness).</li>
</ul>
<h2>Synchronized Random</h2>
<p>The most obvious way to approach this kind of problem is to use <code>Random</code> to generate an index into the given array of available connections. As <code>Random</code> isn't thread-safe, we use a <code>lock</code> to protect it. Even without contention on the <code>lock</code>, this is the slowest possible method clocking in at <strong>26 ns</strong> per load balancing decision.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">Random</span> Random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Connection</span> <span class="token function">Select</span><span class="token punctuation">(</span><span class="token class-name">Connection<span class="token punctuation">[</span><span class="token punctuation">]</span></span> connections<span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token class-name"><span class="token keyword">int</span></span> index<span class="token punctuation">;</span><br>    <span class="token keyword">lock</span> <span class="token punctuation">(</span>Random<span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        index <span class="token operator">=</span> Random<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> connections<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">return</span> connections<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<h2>ThreadStatic Random</h2>
<p>If the application re-uses the threads (thread-pooling) making the load balancing decisions, we can give each thread it’s own <code>ThreadStatic</code> <code>Random</code> instance. This way, we don't have to synchronize access to it. Doing so yields <em>consistently</em> better results at <strong>23 ns</strong> per load balancing decision. Consistently, because this performs independently of possible contention.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ThreadStatic</span></span><span class="token punctuation">]</span> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Random</span> Random<span class="token punctuation">;</span><br><br><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">Connection</span> <span class="token function">Select</span><span class="token punctuation">(</span><span class="token class-name">Connection<span class="token punctuation">[</span><span class="token punctuation">]</span></span> connections<span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> r <span class="token operator">=</span> Random<span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        Random <span class="token operator">=</span> r<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token class-name"><span class="token keyword">var</span></span> index <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> connections<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> connections<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<h2>Pre-Shuffling arrays</h2>
<p>The next two methods are a bit more niche as they involve pre-randomizing the connection array to avoid the calls to <code>Random</code> on the hot path. If only shuffling once isn’t enough, a separate thread could periodically scramble the array in the background. To rearrange the array in-place in linear time, I suggest the use of the so-called <a href="https://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle" title="Fisher-Yates Shuffle - Wikipedia">&quot;Fisher-Yates shuffle&quot;</a>:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token generic-method"><span class="token function">Shuffle</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> arr<span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> i <span class="token operator">=</span> arr<span class="token punctuation">.</span>Length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span><br>    <span class="token punctuation">{</span><br>        <span class="token class-name"><span class="token keyword">var</span></span> j <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>        <span class="token class-name"><span class="token keyword">var</span></span> temp <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span><br>        arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span><br>        arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><span class="token punctuation">}</span></code></pre>
<h2>Increment and Modulo</h2>
<p>We now assume, we have a pre-shuffled list of connections (<code>_connections</code>) and an <code>_index</code> on the load balancer class. This way, we can implement the actual load balancing decision with a simple <code>Interlocked.Increment</code> to add 1 to the <code>_index</code> in a thread-safe fashion and a modulo operation to ensure the index lies within the bounds of the <code>_connections</code> array. This approach is significantly faster than the previous two, clocking in at <strong>13 ns</strong>.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name">Connection</span> <span class="token function">Select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> index <span class="token operator">=</span> Interlocked<span class="token punctuation">.</span><span class="token function">Increment</span><span class="token punctuation">(</span><span class="token keyword">ref</span> _index<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token class-name"><span class="token keyword">var</span></span> connections <span class="token operator">=</span> _connections<span class="token punctuation">;</span><br>    <span class="token keyword">return</span> connections<span class="token punctuation">[</span>index <span class="token operator">%</span> connections<span class="token punctuation">.</span>Length<span class="token punctuation">]</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<p><em>Note:</em> As a simple yet effective optimization, we copy the <code>_connections</code> reference to a local variable <code>connections</code> which produces slightly better (-1 ns) code.</p>
<h2>CAS Linked List</h2>
<p>The runtime cost of the previous approach is mainly due to three things:</p>
<ol>
<li>The <code>Interlocked</code> operation ensuring thread-safety</li>
<li>The <code>idiv</code> emitted by the module operation ensuring we always read within the bounds of the array</li>
<li>The bounds-check the runtime does when accessing the array (although the modulo provides safe reads)</li>
</ol>
<p>We cannot just drop thread-safety as a design constraint, so we will most likely always use a <code>lock </code> or at least an <code>Interlocked</code> method. But we may be able to remove the <code>idiv</code>. And indeed, we are by using a linked list of all things.</p>
<h4>Aside</h4>
<p>Linked lists are generally known for their sub-par performance as a standard list implementation. They fell into discredit because data locality is suboptimal (elements in the list are not necessarily close to each other in memory), and random-access has <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span> cost. In this specific case, however, we can write better-performing code by using a linked list. <strong>Your mileage may vary</strong>: the larger the list, the bigger the chances that you will see performance loss due to bad data locality. To counter that, you can try to allocate the <code>Connection</code> objects and the linked list <code>Node</code>s in a tight loop. This way, the runtime will likely place them close to each other in memory. But there is no guarantee.</p>
<p>On to the implementation: We use a hand-written linked list in which each node comprises a reference to a <code>Connection</code> object and a reference to the next item in the list (known as &quot;singly linked list&quot;). Our load balancer class then holds a reference to the current &quot;head&quot; (a <code>Node</code>) of the list, which was created from a pre-shuffled array, as shown above. The actual load balancing method is then made up of a single CAS-loop (compare-and-swap), which will store the current node, move the &quot;head&quot; to the next item in the list using <code>Interlocked.CompareExchange</code> and return the <code>Connection</code> of the previously stored <code>Node</code>. If it detects that another thread messed with the list in the meantime, it tries again and again. Another reason why <strong>you may observe different results</strong>: if contention is so high, that a majority of the threads lose the CAS-race, performance will suffer, performance will suffer. In my case, however, the load balancing decision is only a small part of a much larger program with relatively little contention on the LB. When measured with no contention at all, this approach yields a load balancing decision roughly every <strong>10 ns</strong>.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name">Connection</span> <span class="token function">Select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token class-name">Node</span> selected<span class="token punctuation">;</span><br>    <span class="token keyword">do</span><br>    <span class="token punctuation">{</span><br>        selected <span class="token operator">=</span> _node<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><br>        Interlocked<span class="token punctuation">.</span><span class="token function">CompareExchange</span><span class="token punctuation">(</span><br>            <span class="token keyword">ref</span> _node<span class="token punctuation">,</span> selected<span class="token punctuation">.</span>Next<span class="token punctuation">,</span> selected<br>        <span class="token punctuation">)</span> <span class="token operator">!=</span> selected<br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> selected<span class="token punctuation">.</span>Current<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
<blockquote>
<p>The full source is on GitHub at <a href="https://github.com/tkp1n/lb" title="lb - GitHub">tkp1n/lb</a></p>
</blockquote>
<h2>The numbers</h2>
<table>
<thead>
<tr>
<th>Method</th>
<th style="text-align:right">Mean</th>
<th style="text-align:right">Error</th>
<th style="text-align:right">StdDev</th>
<th style="text-align:right">Ratio</th>
</tr>
</thead>
<tbody>
<tr>
<td>SyncRandom</td>
<td style="text-align:right">26.52 ns</td>
<td style="text-align:right">0.1895 ns</td>
<td style="text-align:right">0.1773 ns</td>
<td style="text-align:right">1.00</td>
</tr>
<tr>
<td>ThreadStaticRandom</td>
<td style="text-align:right">22.61 ns</td>
<td style="text-align:right">0.2784 ns</td>
<td style="text-align:right">0.2605 ns</td>
<td style="text-align:right">0.85</td>
</tr>
<tr>
<td>Modulo</td>
<td style="text-align:right">13.13 ns</td>
<td style="text-align:right">0.0464 ns</td>
<td style="text-align:right">0.0388 ns</td>
<td style="text-align:right">0.50</td>
</tr>
<tr>
<td>LinkedList</td>
<td style="text-align:right">10.08 ns</td>
<td style="text-align:right">0.0109 ns</td>
<td style="text-align:right">0.0091 ns</td>
<td style="text-align:right">0.38</td>
</tr>
</tbody>
</table>

                </article>
            </main>
        </div>
        <footer>
            <p>&#169; Nicolas Portmann</p>
        </footer>
    </body>
</html>